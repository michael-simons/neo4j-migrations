<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Michael Simons">
<title>Neo4j-Migrations</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
/*! Stylesheet for CodeRay to loosely match GitHub themes | MIT License */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid;opacity:.35;padding:0 .5em 0 0;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff!important;background:navy!important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:navy}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:teal}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:teal}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:teal}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword{color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:teal}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Neo4j-Migrations</h1>
<div class="details">
<span id="author" class="author">Michael Simons</span><br>
<span id="email" class="email"><a href="mailto:michael.simons@neo4j.com">michael.simons@neo4j.com</a></span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#introduction">1. Introduction</a>
<ul class="sectlevel2">
<li><a href="#introduction-about">1.1. About</a></li>
<li><a href="#introduction-compatibility">1.2. Compatibility</a></li>
<li><a href="#introduction-versions">1.3. Versions</a></li>
<li><a href="#introduction-modules">1.4. Modules</a></li>
<li><a href="#introduction-changelog">1.5. Changelog</a></li>
<li><a href="#introduction-history">1.6. History</a></li>
</ul>
</li>
<li><a href="#download">2. Download</a>
<ul class="sectlevel2">
<li><a href="#download_cli">2.1. CLI</a></li>
<li><a href="#download_core">2.2. Core API</a></li>
<li><a href="#download_springboot">2.3. Spring-Boot-Starter</a></li>
<li><a href="#download_quarkus">2.4. Quarkus</a></li>
<li><a href="#maven-plugin">2.5. Maven-Plugin</a></li>
</ul>
</li>
<li><a href="#concepts">3. Concepts</a>
<ul class="sectlevel2">
<li><a href="#concepts_connectivity">3.1. Connectivity</a></li>
<li><a href="#concepts_locations">3.2. Locations</a></li>
<li><a href="#concepts_migrations">3.3. Migrations</a></li>
<li><a href="#concepts_callbacks">3.4. Callbacks</a></li>
<li><a href="#concepts_catalog">3.5. Using a catalog of items</a></li>
<li><a href="#concepts_naming-conventions">3.6. Naming conventions</a></li>
<li><a href="#concepts_chain">3.7. Chain of applied migrations</a></li>
<li><a href="#concepts_separate-databases">3.8. Separate schema databases</a></li>
<li><a href="#concepts_transactions">3.9. Transactions</a></li>
<li><a href="#concepts_preconditions">3.10. Preconditions</a></li>
<li><a href="#concepts_repairing_broken_chains">3.11. Repairing migrations</a></li>
</ul>
</li>
<li><a href="#usage">4. Usage</a>
<ul class="sectlevel2">
<li><a href="#usage_common">4.1. Common operations</a></li>
<li><a href="#cli">4.2. CLI</a></li>
<li><a href="#usage_core">4.3. Core API</a></li>
<li><a href="#usage_spring-boot-starter">4.4. Spring-Boot-Starter</a></li>
<li><a href="#usage_quarkus">4.5. Quarkus</a></li>
<li><a href="#usage_maven-plugin">4.6. Maven-Plugin</a></li>
<li><a href="#usage_defining_asserting_applying_catalogs">4.7. Defining and using catalogs</a></li>
</ul>
</li>
<li><a href="#appendix">Appendix</a>
<ul class="sectlevel2">
<li><a href="#glossary">Glossary</a></li>
<li><a href="#appendix_xml_schemes">XML Schemes</a></li>
<li><a href="#appendix_refactorings">Refactorings</a></li>
<li><a href="#appendix_annotation">Annotation processing</a></li>
<li><a href="#appendix_extesions">Extensions</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>&#169; Copyright 2020-2022 the original author or authors.</p>
</div>
<div class="quoteblock abstract">
<blockquote>
<div class="paragraph">
<p>This is the Neo4j-Migrations manual version 2.20.0.</p>
</div>
</blockquote>
</div>
</div>
</div>
<div class="sect1">
<h2 id="introduction"><a class="anchor" href="#introduction"></a>1. Introduction</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="introduction-about"><a class="anchor" href="#introduction-about"></a>1.1. About</h3>
<div class="paragraph">
<p>Neo4j-Migrations are a set of tools to make your schema migrations as easy as possible.
They provide a uniform way for applications, the command line and build tools alike to track, manage and apply changes to your database, in short: to refactor your database.
The project is inspired to a large extent by <a href="https://flywaydb.org">FlywayDB</a>, which is an awesome tool for migration of relational databases.
Most things evolve around Cypher scripts, however the Core API of Neo4j-Migrations allows defining Java classes as migrations as well.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations builds directly on top of the official <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java driver</a>, supports Neo4j 3.5, Neo4j 4.1 to 4.4 and Neo4j 5, including enterprise features such as multidatabase support and impersonation.</p>
</div>
<div class="paragraph">
<p>The only dependencies are said driver and <a href="https://github.com/classgraph/classgraph">ClassGraph</a>, the latter being used to find migrations on the classpath.</p>
</div>
<div class="paragraph">
<p>The history of migrations applied is stored as a subgraph in your database.</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-compatibility"><a class="anchor" href="#introduction-compatibility"></a>1.2. Compatibility</h3>
<div class="paragraph">
<p>Neo4j-Migrations is tested only against <a href="https://neo4j.com">Neo4j</a>, the world&#8217;s leading Graph database.
Neo4j-Migrations requires a 5.2+ version of Neo4j Java Driver.
Therefore, Neo4j-Migrations works with Neo4j 3.5, 4.1 - 4.4, 5 and of course, Neo4j-Aura.
It also can be used with an embedded instance, as long as the embedded instances provides the Bolt-Connector, too.
The tooling may or may not work with other databases using the Bolt protocol. We don&#8217;t provide any support for those.</p>
</div>
<div class="paragraph">
<p>The Core API and the JVM based version of the CLI module of Neo4j-Migrations requires at least Java 17 or higher since version 2.0.
Neo4j-Migrations can safely be used on both the class- and module-path.
Native binaries are provided for 64bit versions of macOS, Linux and Windows. The native binaries don&#8217;t require a JVM to be installed.</p>
</div>
<div class="paragraph">
<p>For a version compatible with JDK 8, check the 1.x releases. We still do maintain the latest minor, including support for older versions of Spring Boot (prio to Spring Boot 3). These are also the versions you should be using against Neo4j 4.0.</p>
</div>
<div class="paragraph">
<p>The older releases of Neo4j-Migrations are compiled with JDK 17 while targeting JDK 8.
The Core API is provided as a Multi-Release-Jar in the older releases, providing a <code>module-info.java</code> for JDK 11 and higher, making it a good citizen on the Java module path as well.</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-versions"><a class="anchor" href="#introduction-versions"></a>1.3. Versions</h3>
<div class="paragraph">
<p>Neo4j-Migrations 1.0.0 has been considered stable and was first released in November 2021. Since then, we ensure <a href="https://semver.org">semantic versioning</a>.
This means in cases where you use the Java API directly, you can be sure that patch releases won&#8217;t break your application, and you can always upgrade.</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-modules"><a class="anchor" href="#introduction-modules"></a>1.4. Modules</h3>
<div class="paragraph">
<p>Neo4j-Migrations comes in different flavors:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Core</dt>
<dd>
<p>The core module, providing an API to run both Cypher script and Java-based migrations.
The API includes builders for configuration.
Of course, Neo4j-Migrations works on the module path, and it also has an explicit, correct module definition with a clear API boundary. In addition, we do make use of sealed interfaces for things that are meant to be implemented only by us.</p>
<div class="paragraph">
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations/apidocs/index.html">JavaDoc</a> and <a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations/index.html">Project info</a></p>
</div>
</dd>
<dt class="hdlist1">CLI</dt>
<dd>
<p>A command line tool that supports every interaction that the core module provides.
Native binaries are available for Linux, macOS and Windows.
If you want to use Java-based migrations in the CLI, you must use the JVM distribution.
This is an ideal tool to be put into CI/CD not based on Maven or Gradle.</p>
</dd>
<dt class="hdlist1">Spring-Boot-Starter</dt>
<dd>
<p>Provides all configuration options via the well-known Spring-Boot-Properties mechanism and turns them
into a fully configured Migrations instance that will be applied on application start.
Scripts will be searched sane default location.</p>
<div class="paragraph">
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-spring-boot-starter-parent/neo4j-migrations-spring-boot-autoconfigure/apidocs/index.html">JavaDoc</a> and <a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-spring-boot-starter-parent/index.html">Project info</a></p>
</div>
</dd>
<dt class="hdlist1">Quarkus</dt>
<dd>
<p>An extension for Quarkus, providing full integration of all configuration option via Quarkus' configuration.
Creates a startup observer that applies all resolved migrations at startup.</p>
<div class="paragraph">
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-quarkus-parent/neo4j-migrations-quarkus/apidocs/ac/simons/neo4j/migrations/quarkus/runtime/package-summary.html">JavaDoc</a> and <a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-quarkus-parent/index.html">Project info</a></p>
</div>
</dd>
<dt class="hdlist1">Maven-Plugin</dt>
<dd>
<p>A Maven-plugin that hooks clean, apply and verify operations into the appropriate Maven lifecycles.
Use this to apply migrations during your build.</p>
<div class="paragraph">
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/plugin-info.html">Plugin info</a></p>
</div>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="introduction-changelog"><a class="anchor" href="#introduction-changelog"></a>1.5. Changelog</h3>
<div class="paragraph">
<p>We provide a full changelog on GitHub: <a href="https://github.com/michael-simons/neo4j-migrations/releases">Neo4j-Migrations</a>.
Our commits follow <a href="https://www.conventionalcommits.org/en/v1.0.0/">conventional commits</a>.
The releases are created and published via <a href="https://jreleaser.org">JReleaser</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="introduction-history"><a class="anchor" href="#introduction-history"></a>1.6. History</h3>
<div class="paragraph">
<p>The original idea of Neo4j-Migrations was conceived when working on integrating <a href="https://github.com/spring-projects/spring-data-neo4j">Spring Data Neo4j</a> (back then SDN/RX) into <a href="https://www.jhipster.tech">JHipster</a>.
We needed some Nodes, constraints and relationship to be present in the Neo4j database
for JHipster to do it&#8217;s magic but back then there was no lightweight (in terms of dependencies) tool that did work well with
Neo4j 4.0 (the first Graph database providing reactive data access out of the box).
Neo4j-Migrations filled that gap in early 2020 and has grown ever since.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="download"><a class="anchor" href="#download"></a>2. Download</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="download_cli"><a class="anchor" href="#download_cli"></a>2.1. CLI</h3>
<div class="sect3">
<h4 id="sdkman"><a class="anchor" href="#sdkman"></a>2.1.1. SDKMAN!</h4>
<div class="paragraph">
<p>Neo4j-Migrations is on <a href="https://sdkman.io/sdks#neo4jmigrations">SDKMAN!</a> and can be installed via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">sdk install neo4jmigrations</code></pre>
</div>
</div>
<div class="paragraph">
<p>on Windows, Linux and macOS x86_64.
Arm binaries are not yet available.</p>
</div>
</div>
<div class="sect3">
<h4 id="download_cli_brew"><a class="anchor" href="#download_cli_brew"></a>2.1.2. For homebrew users on macOS</h4>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">brew install michael-simons/homebrew-neo4j-migrations/neo4j-migrations</code></pre>
</div>
</div>
<div class="paragraph">
<p>Autocompletion is automatically installed and available for bash and zsh when you configured Homebrew <a href="https://docs.brew.sh/Shell-Completion">accordingly</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="linux"><a class="anchor" href="#linux"></a>2.1.3. Linux</h4>
<div class="paragraph">
<p>As download from our <a href="https://github.com/michael-simons/neo4j-migrations/releases">release page</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0-linux-x86_64.zip</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="windows"><a class="anchor" href="#windows"></a>2.1.4. Windows</h4>
<div class="paragraph">
<p>As download from our <a href="https://github.com/michael-simons/neo4j-migrations/releases">release page</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0-windows-x86_64.zip</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="architectureindependent"><a class="anchor" href="#architectureindependent"></a>2.1.5. Architecture independent</h4>
<div class="paragraph">
<p>In addition to the above native binaries we still offer a JVM, architecture independent version of Neo4j-Migrations-CLI.
Only the JVM version does support custom, Java-based migrations as shown via the argument <code>--package</code>, the natively compiled versions do not.
Get this version here:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The architecture independent version can be used via Neo4js official <a href="https://www.jbang.dev">JBang</a> catalog:
    <br>
     With JBang installed, run <code>jbang neo4j-migrations@neo4j --help</code> for printing our usage information.
    <br>
     The catalog offers a couple of other scripts as well, check them out with <code>jbang catalog list neo4j</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download_core"><a class="anchor" href="#download_core"></a>2.2. Core API</h3>
<div class="paragraph">
<p>The easiest way to get the Core API is to use a build- and dependency-management tool like Maven or Gradle.
Here are the coordinates:</p>
</div>
<div class="listingblock">
<div class="title">Listing 1. Core API as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in case you fancy Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Listing 2. Core API as Gradle dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation <span class="string"><span class="delimiter">'</span><span class="content">eu.michael-simons.neo4j:neo4j-migrations:2.20.0</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download_springboot"><a class="anchor" href="#download_springboot"></a>2.3. Spring-Boot-Starter</h3>
<div class="paragraph">
<p>Use your dependency management to include the <a href="https://start.spring.io">Spring-Boot</a>-Starter.
The starter automatically triggers the dependency to the Neo4j-Java-Driver, which than can be configured via properties in the <code>spring.neo4j.*</code> namespace.
This starter here has a custom namespace, please refer to <a href="#usage_spring-boot-starter">for more information</a>.</p>
</div>
<div class="listingblock">
<div class="title">Listing 3. Neo4j-Migrations-Spring-Boot-Starter as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-spring-boot-starter<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in case you fancy Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Listing 4. Neo4j-Migrations-Spring-Boot-Starter as Gradle dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="gradle">dependencies {
    implementation 'eu.michael-simons.neo4j:neo4j-migrations-spring-boot-starter:2.20.0'
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="download_quarkus"><a class="anchor" href="#download_quarkus"></a>2.4. Quarkus</h3>
<div class="paragraph">
<p>Use your dependency management to include the <a href="https://quarkus.io">Quarkus</a> extension.
This extension automatically triggers the dependency to the Neo4j extension containing the Neo4j-Java-Driver.
The latter can be configured via properties in the <code>quarkus.neo4j.*</code> namespace.
The namespace for this extension is also <code>org.neo4j.migrations.*</code>.</p>
</div>
<div class="listingblock">
<div class="title">Listing 5. Neo4j-Migrations for Quarkus as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependencies&gt;</span>
    <span class="tag">&lt;dependency&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-quarkus<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;/dependency&gt;</span>
<span class="tag">&lt;/dependencies&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="maven-plugin"><a class="anchor" href="#maven-plugin"></a>2.5. Maven-Plugin</h3>
<div class="paragraph">
<p>Include the Maven-Plugin like this in your build and configure it according to the <a href="#usage_maven-plugin">usage section</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugins&gt;</span>
    <span class="tag">&lt;plugin&gt;</span>
        <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
        <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
        <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
        <span class="tag">&lt;configuration&gt;</span>
            <span class="tag">&lt;user&gt;</span>neo4j<span class="tag">&lt;/user&gt;</span>
            <span class="tag">&lt;password&gt;</span>secret<span class="tag">&lt;/password&gt;</span>
            <span class="tag">&lt;address&gt;</span>bolt://localhost:${it-database-port}<span class="tag">&lt;/address&gt;</span>
            <span class="tag">&lt;verbose&gt;</span>true<span class="tag">&lt;/verbose&gt;</span>
        <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;executions&gt;</span>
            <span class="tag">&lt;execution&gt;</span>
                <span class="tag">&lt;id&gt;</span>migrate<span class="tag">&lt;/id&gt;</span>
                <span class="tag">&lt;goals&gt;</span>
                    <span class="tag">&lt;goal&gt;</span>migrate<span class="tag">&lt;/goal&gt;</span>
                <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;/execution&gt;</span>
            <span class="tag">&lt;execution&gt;</span>
                <span class="tag">&lt;id&gt;</span>default-validate<span class="tag">&lt;/id&gt;</span>
                <span class="tag">&lt;goals&gt;</span>
                    <span class="tag">&lt;goal&gt;</span>validate<span class="tag">&lt;/goal&gt;</span>
                <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;/execution&gt;</span>
        <span class="tag">&lt;/executions&gt;</span>
    <span class="tag">&lt;/plugin&gt;</span>
<span class="tag">&lt;/plugins&gt;</span></code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="concepts"><a class="anchor" href="#concepts"></a>3. Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This chapter deals with various concepts that are applicable for all modules offered.
Especially checkout the page regarding <a href="#concepts_naming-conventions">naming conventions</a>, for all Cypher and Java-based migrations and callbacks.</p>
</div>
<div class="sect2">
<h3 id="concepts_connectivity"><a class="anchor" href="#concepts_connectivity"></a>3.1. Connectivity</h3>
<div class="paragraph">
<p>Neo4j-Migrations solely uses the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java Driver</a>.
Most of the time you pass a pre-configured driver object to our API.
The Spring-Boot-Plugin depends on the driver-instance provided by Spring-Boot which can be configured via properties in the <code>spring.neo4j.*</code> space.
The CLI and Maven-Plugin offer parameters to define the URL, username and password alike.</p>
</div>
<div class="paragraph">
<p>All of this mean that we can keep this chapter short and basically defer to the driver&#8217;s documentation:
<a href="https://neo4j.com/docs/java-manual/current/">The Neo4j Java Driver Manual v4.4</a>.
For ease of use, here are the most common forms of URLs the driver might take.
The URLS all have this format: <code>&lt;NEO4J_PROTOCOL&gt;://&lt;HOST&gt;:&lt;PORT&gt;</code>.
The Neo4j-Protocol might be one of the following:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 18.1818%;">
<col style="width: 9.0909%;">
<col style="width: 72.7273%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">URI scheme</th>
<th class="tableblock halign-left valign-top">Routing</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>neo4j</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Yes</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unsecured</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>neo4j+s</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Yes</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Secured with full certificate</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>neo4j+ssc</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Yes</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Secured with self-signed certificate</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bolt</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Unsecured</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bolt+s</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Secured with full certificate</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>bolt+ssc</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Secured with self-signed certificate</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You don&#8217;t have to care much more about the Driver API than knowing how to create an instance:</p>
</div>
<div class="listingblock">
<div class="title">Listing 6. Create an instance of the Neo4j-Java-Driver</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">org.neo4j.driver.AuthTokens</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Config</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.GraphDatabase</span>;

<span class="type">class</span> <span class="class">HowToCreateADriverInstance</span> {

        <span class="directive">public</span> <span class="directive">static</span> <span class="type">void</span> main(<span class="predefined-type">String</span>... args) {
                <span class="predefined-type">Driver</span> driver = GraphDatabase.driver(
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j://your.database.io</span><span class="delimiter">&quot;</span></span>,
                        AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>),
                        Config.defaultConfig()
                );
        }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This instance needs to be passed than to the Neo4j-Migrations Core API in case you aren&#8217;t using one of our integrations.
Mostly everything else than can be done via Cypher scripts alone.
If you need more control about what happens in a migration, have a look at our <a href="#concepts_migrations_java-based">Java-based migration support</a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="concepts_locations"><a class="anchor" href="#concepts_locations"></a>3.2. Locations</h3>
<div class="paragraph">
<p>You need to store migrations somewhere. Essentially, Neo4j-Migrations offers three categories:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>class- or module-path based packages</p>
</li>
<li>
<p>classpath based locations</p>
</li>
<li>
<p>file based locations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The former does support Java (and Kotlin) classes, the two latter only supports Cypher (and XML) based scripts, for obvious reasons: Neo4j-Migrations won&#8217;t pick up external Java files and compile them for you.</p>
</div>
<div class="paragraph">
<p>Packages are configured through <code>packagesToScan</code> in <code>MigrationConfig</code>. A corresponding property is available in all framework integrations and in the CLI.</p>
</div>
<div class="paragraph">
<p>Locations for resources must be configured through <code>locationsToScan</code>. Again, a corresponding property is available in all framework integrations and in the CLI. Additionally, the <a href="#usage_quarkus">Quarkus integration</a> offers <code>externalLocations</code>. Why? Because <code>locationsToScan</code> will be treated by Quarkus as build-time properties and be resolved during built-time, becoming part of the Jar-file or native image. Hence, you wouldn&#8217;t be able to change them later. <code>externalLocations</code> will stay flexible, the semantics however are the same.</p>
</div>
<div class="sect3">
<h4 id="classpathorfileprotocol"><a class="anchor" href="#classpathorfileprotocol"></a>3.2.1. <code>classpath:</code> or <code>file:</code> protocol?</h4>
<div class="paragraph">
<p>Neo4j-Migrations differentiates for the <code>locationsToScan</code> option between the <code>classpath:</code> and the <code>file:</code> protocol with the following syntax and semantics:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>a/b/c</code></dt>
<dd>
<p>Implicitly assuming <code>classpath:</code>, treating the value <code>a/b/c</code> as the package <code>a.b.c</code>.</p>
</dd>
<dt class="hdlist1"><code>/a/b/c</code></dt>
<dd>
<p>Implicitly assuming <code>classpath:</code>, treating the value <code>a/b/c</code> as the package <code>a.b.c</code>, the leading forward-slash is superfluous and will be stripped.</p>
</dd>
<dt class="hdlist1"><code>classpath:a/b/c</code> respectively <code>classpath:/a/b/c</code></dt>
<dd>
<p>Same as the above, but explicitly enabling classpath scanning in the given package.</p>
</dd>
<dt class="hdlist1"><code>./whatever/../a/b/c</code></dt>
<dd>
<p>Implicitly assuming <code>file:</code>, indicated by the leading dot (<code>.</code>), which has the same semantics as in a filesystem. Neo4j-Migrations will resolve the given relative path against the current working directory and look there for a directory structure of <code>a/b/c</code>.</p>
</dd>
<dt class="hdlist1"><code>../migrations/a/b/c</code></dt>
<dd>
<p>Implicitly assuming <code>file:</code>, indicated by the leading dots (<code>..</code>), which have the same semantics as in a filesystem. Neo4j-Migrations will resolve the given relative path against the current working directory and look in its parent directory for a directory structure of <code>migrations/a/b/c</code>.</p>
</dd>
<dt class="hdlist1">Using the <code>file:</code> uri scheme</dt>
<dd>
<p>This one is a bit tricky, and you might want to read up about it <a href="https://en.wikipedia.org/wiki/File_URI_scheme">here</a>. Neo4j-Migrations is strict about the number of forward slashes here: A valid file URI must begin with either <code>file:/path</code> (no hostname), <code><a href="file:///path" class="bare">file:///path</a></code> (empty hostname), or <code><a href="file://hostname/path" class="bare">file://hostname/path</a></code>. Neo4j-Migrations will strip away any hostname, relative paths are not allowed within the <code>file:</code> uri scheme and will be stripped away.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Note: Scanning the root package is not supported, as it might become slow and sometimes dangerous, too. In the end, you would not want to bring in a dependency that might contain a Cypher resource that fit the naming conventions of Neo4j-Migrations and truncate your database, would you?</p>
</div>
<div class="paragraph">
<p>Any configured file-system location that does not exist or isn&#8217;t a directory will be logged on <code>WARNING</code> level.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_migrations"><a class="anchor" href="#concepts_migrations"></a>3.3. Migrations</h3>
<div class="paragraph">
<p>Migrations are all operations or refactorings you apply to a database.
These operations might be creating, changing, or dropping indexes and constraints or altering data.
Sometimes you might even want to create users or databases.</p>
</div>
<div class="paragraph">
<p>Cypher (<code>.cypher</code>), Catalog-based (<code>.xml</code>) and class based (i.e. <code>.java</code> or <code>.kt</code>) based migrations require a certain naming
convention to be recognized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">V1_2_3__Add_last_name_index.(cypher|xml|java)</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefix <code>V</code> for "<em>V</em>ersioned migration" or <code>R</code> for "<em>R</em>epeatable migration"</p>
</li>
<li>
<p>Version with optional underscores separating as many parts as you like</p>
</li>
<li>
<p>Separator: <code>__</code> (two underscores)</p>
</li>
<li>
<p>Required description: Underscores or spaces might be used to separate words</p>
</li>
<li>
<p>Suffix: Depending on the given type.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Exceptions are made for callbacks (see <a href="#concepts_naming-conventions">naming conventions</a>) and some <a href="#">extensions</a> supported by Neo4j-Migrations.</p>
</div>
<div class="sect3">
<h4 id="concepts_migrations_cypher-based"><a class="anchor" href="#concepts_migrations_cypher-based"></a>3.3.1. Cypher-based</h4>
<div class="paragraph">
<p>Cypher-based migrations can be mostly anything you can write down as <a href="https://neo4j.com/docs/cypher-refcard/current/">Cypher statement</a>.
A Cypher-based migration can contain one or more statements with multiple lines separated by a <code>;</code> followed by a new line.
By default, all statements in one script will be executed in a single transaction.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example:</p>
</div>
<div class="listingblock">
<div class="title">Listing 7. neo4j/migrations/V007__BondTheNameIsBond.cypher</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE (agent:`007`) RETURN agent;
UNWIND RANGE(1,6) AS i
WITH i CREATE (n:OtherAgents {idx: '00' + i})
RETURN n
;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This script contains two different statements.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations will by default look in <code>classpath:neo4j/migrations</code> for all <code>*.cypher</code> files matching the name described in
<a href="#concepts_naming-conventions">Section 3.6</a>. You can change (or add to this default) with the Core API or the appropriate properties in
Spring-Boot-Starter or the Maven-Plugin like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 8. Changing the locations to scan for Migrations (and Callbacks) via the Core API</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MigrationsConfig configLookingAtDifferentPlaces = MigrationsConfig.builder()
    .withLocationsToScan(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:my/awesome/migrations</span><span class="delimiter">&quot;</span></span>, <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/path/to/migration</span><span class="delimiter">&quot;</span></span> <i class="conum" data-value="2"></i><b>(2)</b>
    ).build();</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Look at a different place on the classpath</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Look additional at the given filesystem path</td>
</tr>
</table>
</div>
<div class="sect4">
<h5 id="switchingdatabaseinsidecypherscripts"><a class="anchor" href="#switchingdatabaseinsidecypherscripts"></a>Switching database inside Cypher scripts</h5>
<div class="sect5">
<h6 id="withthecommanduse"><a class="anchor" href="#withthecommanduse"></a>With the command <code>:USE</code></h6>
<div class="paragraph">
<p>The command <code>:USE</code> has the same meaning as in Neo4j-Browser or Cypher-Shell: All following commands will be applied in the given database.
The transaction mode will be applied as configured per database and will "restart" when you switch the database again.
This is the preferred way of doing things like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 9. Switching databases in flight with <code>:USE</code></div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE database foo IF NOT EXISTS WAIT;
:use foo;
CREATE (n:InFoo {foo: 'bar'});
:use neo4j;
CREATE (n:InNeo4j);</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="withthecypherkeyworduse"><a class="anchor" href="#withthecypherkeyworduse"></a>With the Cypher keyword <code>USE</code></h6>
<div class="paragraph">
<p>It is of course possible to use the Cypher keyword <code>USE &lt;graph&gt;</code> (See <a href="https://neo4j.com/docs/cypher-manual/current/clauses/use/">USE</a>) inside your scripts.
There are a couple of things to remember, though:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It can get tricky if you combine it in creative ways with the options for schema- and target-databases Neo4j-Migrations offer itself</p>
</li>
<li>
<p>If you have more than one statement per script (which is completely not a problem) and one of them should use <code>USE</code> you must
configure Neo4j-Migrations to use <code>TransactionMode#PER_STATEMENT</code> (see <a href="#concepts_transactions">Section 3.9</a>, meaning to run each statement of a script in a separate transaction.
This is slightly more error-prone, as it will most likely leave your database in an inconsistent state if one statement fails, since everything
before has already been committed.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="concepts_migrations_catalog-based"><a class="anchor" href="#concepts_migrations_catalog-based"></a>3.3.2. Based on a catalog</h4>
<div class="paragraph">
<p>Migrations can be used to define a local catalog in an iterative fashion. Each migration discovered will contribute to a catalog
known in the context of a <code>Migration</code> instance.</p>
</div>
<div class="paragraph">
<p>Catalog based migrations are written in XML and can contain one <code>&lt;catalog /&gt;</code> item per migration and many <code>&lt;operation /&gt;</code> items
per migration.</p>
</div>
<div class="paragraph">
<p>The simplest way of defining a catalog based migrations looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 10. V01__Create_unique_isbn.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;create&gt;</span>
    <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_isbn</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;label&gt;</span>Book<span class="tag">&lt;/label&gt;</span>
      <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;property&gt;</span>isbn<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/constraint&gt;</span>
  <span class="tag">&lt;/create&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here a unique constraint is defined for the property <code>isbn</code> of all nodes labelled <code>Book</code>. This constraint is known only locally
and does not contribute to the contextual catalog.</p>
</div>
<div class="paragraph">
<p>This can also be rewritten such as this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 11. V01__Create_unique_isbn.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;catalog&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_isbn</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Book<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>isbn<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>
  <span class="tag">&lt;create</span> <span class="attribute-name">item</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_isbn</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The constraint can be reused later, too:</p>
</div>
<div class="listingblock">
<div class="title">Listing 12. V23__Drop_old_constraint.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;drop</span> <span class="attribute-name">item</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_isbn</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Indexes are supported, too:</p>
</div>
<div class="listingblock">
<div class="title">Listing 13. V01__Create_an_index_local.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;create&gt;</span>
    <span class="tag">&lt;index</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">node_index_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
      <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;property&gt;</span>surname<span class="tag">&lt;/property&gt;</span>
      <span class="tag">&lt;/properties&gt;</span>
    <span class="tag">&lt;/index&gt;</span>
  <span class="tag">&lt;/create&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The XML schema supports types for indexes as well: <code>FULLTEXT</code> and <code>TEXT</code>. The former being the well known
      Lucene backed indexes, the latter the new <code>TEXT</code> index introduced in Neo4j.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To learn more about the scheme, have a look at the <a href="#appendix_xml_schemes_migration">XML schema explained</a> and also make
sure you follow the <a href="#concepts_catalog">concepts about catalogs</a> as well as the <a href="#usage_defining_asserting_applying_catalogs">catalog examples</a>.</p>
</div>
<div class="paragraph">
<p>Last but not least, Neo4j-Migrations offers several built-in refactorings, modelled after <a href="https://neo4j.com/labs/apoc/4.4/overview/apoc.refactor/">APOC Refactor</a> but without requiring APOC to be installed inside the database or cluster.</p>
</div>
<div class="paragraph">
<p>The example given in the APOC docs above can be identically modelled with the following catalog item:</p>
</div>
<div class="listingblock">
<div class="title">Listing 14. V42__Rename_labels.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.label</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;parameters&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Engineer<span class="tag">&lt;/parameter&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>DevRel<span class="tag">&lt;/parameter&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">customQuery</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span><span class="inline-delimiter">&lt;![CDATA[</span>
        MATCH (person:Engineer)
        WHERE person.name IN [&quot;Mark&quot;, &quot;Jennifer&quot;, &quot;Michael&quot;]
        RETURN person
      <span class="inline-delimiter">]]&gt;</span><span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;/parameters&gt;</span>
  <span class="tag">&lt;/refactor&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It will rename the label <code>Engineer</code> on all nodes matching the custom query to <code>DevRel</code>.</p>
</div>
<div class="paragraph">
<p>All supported refactorings are described in <a href="#appendix_refactorings">Refactorings</a>.</p>
</div>
<div class="paragraph">
<p><strong>What&#8217;s the advantage of using XML instead of a Cypher-based migration for this purpose?</strong>
The syntax for defining constraints and indexes has been changed considerably over the last decade of Neo4j versions and
many variants that used to be possible in Neo4j 3.5 have been deprecated for a while and will vanish in Neo4j 5.0.</p>
</div>
<div class="paragraph">
<p>With a neutral representation of constraints and indexes, we can translate these items into the syntax that fits your target
database. In addition, we also can do idempotent operations on older databases that don&#8217;t actually have them.</p>
</div>
<div class="paragraph">
<p>Furthermore, some structured form is necessary for creating a representation of concepts like refactorings.</p>
</div>
<div class="paragraph">
<p><strong>What&#8217;s the advantage of using Catalog-based migrations for the purpose of creating constraints and indexes for specific
versions of Neo4j compared to Cypher-based migrations with <a href="#concepts_preconditions">preconditions</a>?</strong> When using preconditions
it is up to you to take care of newer versions of Neo4j as they come available as well as making sure you get the syntax right.
Using a Catalog-based migration frees you from this duty. Preconditions have been available earlier than the
<a href="#concepts_catalog">concept of a catalog</a> and can be used for many purposes (i.e. making sure actual data exists).
In contrast to that, Catalog-based migrations have a very strong focus on actual schema items.</p>
</div>
<div class="paragraph">
<p>However, Catalog-based migrations offer support for preconditions too. They can be added as XML processing instructions
anywhere in the document and look like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 15. Example for preconditions as processing instructions</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;?assert that edition is enterprise ?&gt;</span>
  <span class="comment">&lt;?assume q' RETURN true?&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>They can appear anywhere in the document, but we recommend putting them into the root element.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
While both elements - <code>constraint</code> and <code>index</code> - do support a child element named <code>options</code>, these are not
         rendered or used yet.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="concepts_migrations_java-based"><a class="anchor" href="#concepts_migrations_java-based"></a>3.3.3. Java-based</h4>
<div class="paragraph">
<p>Neo4j-Migrations provides the interface <code>ac.simons.neo4j.migrations.core.JavaBasedMigration</code> for you to implement.
Based on that interface you can do much more than just migrate things via adding or changing data:
You can refactor everything in your database in a programmatic way.
One possible migration looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 16. Example for a Java-based refactoring</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">some.migrations</span>;

<span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.core.JavaBasedMigration</span>;
<span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.core.MigrationContext</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Session</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">V001__MyFirstMigration</span> <span class="directive">implements</span> JavaBasedMigration {

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> apply(MigrationContext context) {
        <span class="keyword">try</span> (Session session = context.getSession()) { <i class="conum" data-value="1"></i><b>(1)</b>
            <span class="comment">// Steps necessary for a migration</span>
        }
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>MigrationContext</code> provides both <code>getSession()</code> or <code>getSessionConfig()</code> to be used in combination with <code>getDriver()</code>.
The latter is helpful when you want to have access to a reactive or asynchronous session.
It is important that you use the convenience method <code>getSession()</code> or create a session with the provided config as only
those guarantee that your database session will be connected to the configured target database with the configured user.
In addition, our context will take care of managing Neo4j causal cluster bookmarks.
However, if you feel like it is necessary to switch to a different database, you can use the driver instance any way you want.
The transaction handling inside Java-based migrations is completely up to you.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You don&#8217;t have to annotate your Java-based migrations in any way.
Neo4j-Migrations will find them on the classpath as is.
The same naming requirements that apply to Cypher scripts apply to Java-based migrations as well, see <a href="#concepts_naming-conventions">Section 3.6</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
There are some restrictions when it comes to run Neo4j-Migrations on GraalVM native image:
      You might or might not be able to convince the runtime to find implementations of an interface in native image.
      You must at least explicitly include those classes in the native image unless used otherwise as well.
     <br>
      The CLI will outright refuse to scan for Java-based migrations in its native form (when using the <code>--package</code> option).
      It does support them only in JVM mode.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>While you can theoretically extend the public base interface <code>Migration</code> too, we don&#8217;t recommend it.
In fact, on JDK 17 we forbid it.
Please use only <code>JavaBasedMigration</code> as the base interface for your programmatic migrations.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_callbacks"><a class="anchor" href="#concepts_callbacks"></a>3.4. Callbacks</h3>
<div class="paragraph">
<p>Callbacks are part of a refactoring or a chain of migration that lives outside the chain of things.
As such these callbacks can be used to make sure certain data, constructs or other preconditions are available or fulfilled before anything else happens.
They also come in handy during integration tests.
You might want to have your migrations as part of the main source tree of your application and
at the same time have in your tests source tree the same folder with a bunch of callbacks that
create test data for example in an <code>afterMigrate</code> event.</p>
</div>
<div class="paragraph">
<p>Callbacks are not considered immutable after they have been invoked and their invocation is not stored in the history graph.
This gives you a hook to add some more volatile things to your refactoring.</p>
</div>
<div class="paragraph">
<p>The <code>beforeFirstUse</code> callback is especially handy in cases in which you want to create the target database before migrations
are applied: It will always be invoked inside the home database of the connected user, so at this point, the target database
does not need to exist yet.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Be aware that for this to work you <strong>must</strong> specify both <strong>target</strong> and <strong>schema</strong> database: The schema database must exist
      and cannot be created with a <code>beforeFirstUse</code> callback. This due to the fact that migrations will always be run inside
      lock represented by a couple of Nodes.
     <br>
      An appropriate CLI call would look like this:
     <br>
      <code>neo4j-migrations --schema-database neo4j --database canBeCreatedWithCallback apply</code>
     <br>
      A corresponding callback would contain:
     <br>
      <code>CREATE DATABASE canBeCreatedWithCallback IF NOT EXISTS;</code>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="concepts_lifecycle-phases"><a class="anchor" href="#concepts_lifecycle-phases"></a>3.4.1. Lifecycle phases</h4>
<div class="paragraph">
<p>The following phases are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">beforeFirstUse</dt>
<dd>
<p>The only phase that only runs once for any given instance of Neo4j-Migrations.
It will run before any other operations are called, when the first connection is opened.
Callbacks in this phase will always be invoked in the schema database and not the target database,
so they won&#8217;t require the target database to be present.
Also, no user impersonation will be performed.
This can be used to create the target database before any migrations or validations are run.</p>
</dd>
<dt class="hdlist1">beforeMigrate</dt>
<dd>
<p>Before migrating a database.</p>
</dd>
<dt class="hdlist1">afterMigrate</dt>
<dd>
<p>After migrating a database, independent of outcome.</p>
</dd>
<dt class="hdlist1">beforeClean</dt>
<dd>
<p>Before cleaning a database.</p>
</dd>
<dt class="hdlist1">afterClean</dt>
<dd>
<p>After cleaning a database, independent of outcome.</p>
</dd>
<dt class="hdlist1">beforeValidate</dt>
<dd>
<p>Before validating a database.</p>
</dd>
<dt class="hdlist1">afterValidate</dt>
<dd>
<p>After validating a database, independent of outcome.</p>
</dd>
<dt class="hdlist1">beforeInfo</dt>
<dd>
<p>Before getting information about the target database.</p>
</dd>
<dt class="hdlist1">afterInfo</dt>
<dd>
<p>After getting information about the target database.</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_catalog"><a class="anchor" href="#concepts_catalog"></a>3.5. Using a catalog of items</h3>
<div class="paragraph">
<p>Neo4j is schema free or a database with little schema. There are labels for nodes, types for relationships and both can
have properties. Hence, property graph. But there&#8217;s no "hard" schema determining that all nodes have all the same properties
with the same type.</p>
</div>
<div class="paragraph">
<p>However, there are concepts to force the existence of properties on entities: Constraints.
Constraints can also enforce uniqueness and keys; they go hand in hand with indexes. Constraints and indexes are what we refer
to in Neo4j-Migrations as schema.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Why the heck XML? While XML has been badmouthed for a while now, it has a couple of advantages over JSON and YAML,
      especially in terms of schema: There are many options to validate a given document, Document Type Definition (DTD)
      and XML Schema being two of them. Neo4j-Migrations opted for the latter, it is documented in the <a href="#appendix_xml_schemes_migration">appendix</a>.
      Most of your tooling should be able to load this and validate any migration for you and guide you to what is possible
      and what not.
     <br>
      Our benefit lies in the fact that XML support comes directly with the JVM, and we don&#8217;t need to introduce any additional
      dependencies to parse and validate content.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>A catalog is also used to represent predefined or built-in <a href="#appendix_refactorings">refactorings</a>, such as renaming all occurrences of types or labels.</p>
</div>
<div class="sect3">
<h4 id="whatisacatalog"><a class="anchor" href="#whatisacatalog"></a>3.5.1. What is a catalog?</h4>
<div class="paragraph">
<p>Inside Neo4j-Migrations the concept of a catalog has been introduced. A catalog holds the same type of entities as a schema
and migrations can pick up elements from the catalog to define the final schema.</p>
</div>
<div class="paragraph">
<p>Items can reside multiple times inside the catalog, identified by their id and the version of the migration in which
they have been defined. This is so that a drop operation for example can refer to the last version of an entity applied
to the schema and not to the latest, in which properties or options might have change.</p>
</div>
<div class="paragraph">
<p>Refactorings exists as a general concept in a catalog, they don&#8217;t need to be defined, but just declared as an <a href="#catalog_operations">operation</a> to be executed.</p>
</div>
<div class="sect4">
<h5 id="howisacatalogdefined"><a class="anchor" href="#howisacatalogdefined"></a>How is a catalog defined?</h5>
<div class="paragraph">
<p>The catalog comes in two flavors, the remote and the local catalog. The remote catalog - or in other words the catalog defined by
the databases' schema - is the easier one to understand: It is a read-only view on all items contained in the database schema
that Neo4j-Migrations supports, such as constraints and indexes. It can be retrieved on demand any time.</p>
</div>
<div class="paragraph">
<p>The local catalog is a bit more complex: It is built in an iterative way when discovering migrations. Catalog-based migrations
are read in versioning order. Items in their <code>&lt;catalog /&gt;</code> definition are required to have a unique id (name) per migration.
All items are added in a versioned manner to the local catalog. If an item named <code>a</code> is defined in both version <code>n</code> and <code>n+x</code>,
it will be accessible in the catalog in both variants. Thus, Neo4j-Migrations can for example support dropping of unnamed
items and recreating them in a new fashion. The approach of a versioned, local catalog also allows executing advanced operations
like <code>verify</code>: The verification of the remote catalog against the local catalog triggered in migration <code>n+1</code> can refer to
the local catalog in version <code>n</code> (the default) to assert the ground for all following operations, or for the current version
to make sure everything exists in a given point in time without executing further operations.</p>
</div>
<div class="paragraph">
<p>Last but not least: Sometimes it is required to start fresh in a given migration. For this purpose the catalog element supports
an additional attribute <code>reset</code>. Setting this to true in any given migration will cause the catalog to be reset in this version.
Resetting means either being replaced with an empty catalog (<code>&lt;catalog reset="true" /&gt;</code>) or replaced with the actual content.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="catalog_operations"><a class="anchor" href="#catalog_operations"></a>3.5.2. Operations working with a catalog</h4>
<div class="paragraph">
<p>Operations available to catalog based migrations are</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>create</code></dt>
<dd>
<p>Create an item</p>
</dd>
<dt class="hdlist1"><code>drop</code></dt>
<dd>
<p>Drop an item</p>
</dd>
<dt class="hdlist1"><code>verify</code></dt>
<dd>
<p>Verify the locally defined catalog against the remote schema</p>
</dd>
<dt class="hdlist1"><code>apply</code></dt>
<dd>
<p>Drop all supported types from the remote schema and create all elements of the local catalog.</p>
</dd>
<dt class="hdlist1"><code>refactor</code></dt>
<dd>
<p>Execute one of several predefined refactorings</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>While <code>create</code> and <code>drop</code> work on single item,  <code>verify</code> and <code>apply</code> work on the whole, known catalog  in a defined version range.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
A word on naming: Neo4j-Migrations requires unique names of catalog items across the catalog. In contrast to the
Neo4j database itself, using the name <code>wurstsalat</code> for both a constraint and an index is prohibited. Recommended
names in this case would be <code>wurstsalat_exists</code> and <code>wurstsalat_index</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Both <code>create</code> and <code>drop</code> operations are idempotent by default.
This behaviour can be changed using <code>ifNotExists</code> and <code>ifExists</code> attributes with a value of <code>false</code>.</p>
</div>
<div class="paragraph">
<p>Be aware that idempotent does not mean "force", especially in the <code>create</code> case. If you want to update / replace an existing
constraint, and you are unsure if it does exist or not, use</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;drop</span> <span class="attribute-name">item</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">ifExists</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;create</span> <span class="attribute-name">item</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">a</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The drop operation will ensure that the constraint goes away, and the <code>create</code> operation will safely build a new one.</p>
</div>
<div class="sect4">
<h5 id="verificationorassertions"><a class="anchor" href="#verificationorassertions"></a>Verification (or assertions)</h5>
<div class="paragraph">
<p><code>verify</code> asserts that all items in the catalog are present in an equivalent or identical form in the database. This is a useful
step inside a migration to make sure things are "as you expect" before applying further migrations. Thus, it can only be
used before running any <code>create</code>, <code>drop</code> or <code>apply</code> commands.</p>
</div>
<div class="paragraph">
<p>The catalog items that are subject to the verification are by default made up from all prior versions to the migration
in which the <code>verify</code> appears. As an example, inside migration <code>V2.1</code> a <code>verify</code> appears. All catalog items from versions
1.0 upto 2.0 will take part of the assertion. Items defined in 2.1 with the same name won&#8217;t be asserted, so that you can
assert a given state and then redefine parts of it for example.
This behavior can be changed by using the attribute <code>latest</code>, setting it to <code>true</code> on the element (<code>&lt;verify latest="true" /&gt;</code>).
This will take the catalog as defined in <strong>this</strong> version.</p>
</div>
</div>
<div class="sect4">
<h5 id="applyingthewholecatalog"><a class="anchor" href="#applyingthewholecatalog"></a>Applying the whole catalog</h5>
<div class="paragraph">
<p><code>apply</code> on the other hands drops all items in the current physical schema and creates all items in state of the catalog
at the current version of migration. From the same example as above, everything from 1.0 upto and including 2.1 will be
included, definitions will be identified by their name respectively id.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
The <code>apply</code> operation loads all supported item types from the database, drops them and then creates all items of
         the local catalog. This is a potentially destructive operation as it might drop items you have no replacement for.
        <br>
         Also be aware that neo4j-migrations will never drop the constraints needed for the locking node to function proper
         (Basically, none of the constraints defined for the label <code>__Neo4jMigrationsLock</code>).
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>apply</code> can&#8217;t be used together with <code>drop</code> or <code>create</code> in the same migration.</p>
</div>
</div>
<div class="sect4">
<h5 id="executingrefactorings"><a class="anchor" href="#executingrefactorings"></a>Executing refactorings</h5>
<div class="paragraph">
<p><code>refactor</code> is used to run parameterized predefined refactorings. The <code>refactor</code> element can be used after the <code>verify</code> operation and before, after or in between <code>drop</code> or <code>create</code> operations. It will be executed in the order in which it was defined. It cannot be used together with <code>apply</code>.
Have a look at the general <a href="#concepts_migrations_catalog-based">catalog example</a> or at the <a href="#appendix_refactorings">appendix</a> for some concrete examples of executing predefined refactorings.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="createacatalogfromtheactualdatabaseschema"><a class="anchor" href="#createacatalogfromtheactualdatabaseschema"></a>3.5.3. Create a catalog from the actual database schema</h4>
<div class="paragraph">
<p>The API provides <code>getDatabaseCatalog</code> and <code>getLocalCatalog</code> methods.
The former reads all supported items in the Neo4j schema and creates a catalog view on them, the latter provides access
to the catalog defined by all migrations.</p>
</div>
<div class="paragraph">
<p>Those methods are used by the CLI to provide the ability to dump the whole database schema as a catalog definition in our
own XML format or as Cypher script targeting a specific Neo4j version.</p>
</div>
<div class="paragraph">
<p>Last but not least, there&#8217;s public API <code>ac.simons.neo4j.migrations.core.catalog.CatalogDiff.between</code> that can be used to
diff two catalogs and evaluate whether they are identical, equivalent or different to each other.</p>
</div>
<div class="paragraph">
<p>Refactorings cannot be derived from an existing database.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_naming-conventions"><a class="anchor" href="#concepts_naming-conventions"></a>3.6. Naming conventions</h3>
<div class="sect3">
<h4 id="cypher-basedresources"><a class="anchor" href="#cypher-basedresources"></a>3.6.1. Cypher-based resources</h4>
<div class="paragraph">
<p>All Cypher-based resources (especially migration and callback scripts) require <code>.cypher</code> as extension.
The Core API, the Spring-Boot-Starter and the Maven-Plugin will by default search for such Cypher scripts in <code>classpath:neo4j/migrations</code>.
The CLI has no default search-location.</p>
</div>
<div class="sect4">
<h5 id="concepts_naming-conventions_migration_scripts"><a class="anchor" href="#concepts_naming-conventions_migration_scripts"></a>Migration scripts</h5>
<div class="paragraph">
<p>A Cypher script based migration must have a name following the given pattern to be recognized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">V1_2_3__Add_last_name_index.cypher</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Prefix <code>V</code> for "<em>V</em>ersioned migration" or <code>R</code> for "<em>R</em>epeatable migration"</p>
</li>
<li>
<p>Version with optional underscores separating as many parts as you like</p>
</li>
<li>
<p>Separator: <code>__</code> (two underscores)</p>
</li>
<li>
<p>Required description: Underscores or spaces might be used to separate words</p>
</li>
<li>
<p>Suffix: <code>.cypher</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This applies to both Cypher scripts outside an application (in the file system) and inside an application (as resources).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Cypher-based migrations scripts are considered to be immutable once applied.
We compute their checksums and record it inside the schema database.
If you change a Cypher-based migration after it has been applied, any further application will fail.
By marking a migration as repeatable you indicate that it is safe to repeat it whenever its checksum changes.
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="callbackscripts"><a class="anchor" href="#callbackscripts"></a>Callback scripts</h5>
<div class="paragraph">
<p>A Cypher script is recognized as a callback for a given lifecycle if it matches the following pattern:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">nameOfTheLifecyclePhase.cypher
nameOfTheLifecyclePhase__optional_description.cypher</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>nameOfTheLifecyclePhase</code> must match exactly (case-sensitive) the name of one of the supported lifecycle phases (see <a href="#concepts_lifecycle-phases">Section 3.4.1</a>),
followed by an optional description and the suffix <code>.cypher</code>, separated from the name of the phase by two underscores (<code>__</code>).
The description is used to order different callback scripts for the same lifecycle phase.
If you use more than one script in the same lifecycle phase without a description, the order is undefined.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Callback scripts are not considered to be immutable and can change between execution.
If you use DDL statements such as <code>CREATE USER</code> or <code>CREATE DATABASE</code> in them make sure you look for an <code>IF NOT EXITS</code>
option in your desired clause so that these statements become idempotent.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect3">
<h4 id="catalog-basedmigrations"><a class="anchor" href="#catalog-basedmigrations"></a>3.6.2. Catalog-based migrations</h4>
<div class="paragraph">
<p>Catalog-based migrations (See <a href="#concepts_catalog">Section 3.5</a>) are XML files based on the <code>migration.xsd</code> scheme. As such they require
the extension <code>.xml</code> and otherwise follow the same naming conventions as <a href="#concepts_naming-conventions_migration_scripts">Cypher-based resources</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="java-basedmigrations"><a class="anchor" href="#java-basedmigrations"></a>3.6.3. Java-based migrations</h4>
<div class="paragraph">
<p>For Java (or actually anything that can be compiled to a valid Java class) based migrations, the same naming conventions apply as for
<a href="#concepts_naming-conventions_migration_scripts">Cypher-based scripts</a> apart from the extension.
To stick with the above example, <code>V1_2_3__Add_last_name_index.cypher</code> becomes <code>V1_2_3__Add_last_name_index</code> as simple class name,
or in source form, <code>V1_2_3__Add_last_name_index.java</code>.</p>
</div>
<div class="paragraph">
<p>Our recommendation is to use something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">class</span> <span class="class">V1_2_3__AddLastNameIndex</span> <span class="directive">implements</span> JavaBasedMigration {
    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> apply(MigrationContext context) {
        <span class="comment">// Your thing</span>
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> getSource() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Add last name index</span><span class="delimiter">&quot;</span></span>; <i class="conum" data-value="1"></i><b>(1)</b>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Defaults to the simple class name being added to the history chain.</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_chain"><a class="anchor" href="#concepts_chain"></a>3.7. Chain of applied migrations</h3>
<div class="paragraph">
<p>All migrations applied to a target database are stored in the schema database.
The target and the schema database can be the same database.
If you are an enterprise customer managing different databases for different tenants that are however used for the same application,
it makes absolutely sense to use a separate schema database that stores all data related to Neo4j-Migrations.</p>
</div>
<div class="paragraph">
<p>The subgraph will look like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="img/chain-of-migrations.png" alt="chain of migrations">
</div>
</div>
<div class="paragraph">
<p>In case you use a schema database for any database with a different name than the default (which is <code>neo4j</code>) the nodes
labelled <code>__Neo4jMigration</code> will have an additional property name <code>migrationTarget</code> which contains the target graph.</p>
</div>
<div class="paragraph">
<p>The chain of applied migrations is stable, and you can of course query it (for example in <a href="#concepts_callbacks">callbacks</a>),
but you should not modify it in any way or form.
In case you want to get rid of it, please use the <a href="#usage_common_clean"><code>clean</code></a> operation.</p>
</div>
</div>
<div class="sect2">
<h3 id="concepts_separate-databases"><a class="anchor" href="#concepts_separate-databases"></a>3.8. Separate schema databases</h3>
<div class="paragraph">
<p>Since version 1.1.0 you can use a different database for storing information about migrations.
You need to run a Neo4j 4+ Enterprise Edition.
The command line argument and the property, respectively, is <code>schema-database</code> throughout the configuration.
The name given must be a valid Neo4j database name (See <a href="https://neo4j.com/docs/operations-manual/current/manage-databases/configuration/">Administration and configuration</a>).
The database must exist and the user must have write access to it.</p>
</div>
<div class="paragraph">
<p>Valid scenarios are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using a schema database for one other database</p>
</li>
<li>
<p>Using a schema database for maintaining multiple migrations of different databases</p>
</li>
<li>
<p>Using pairs of schema databases and target databases</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Neo4j-Migrations will create subgraphs in the schema database identifiable by a <code>migrationTarget</code>-property in the <code>__Neo4jMigration</code>-nodes.
Neo4j-Migrations will <strong>not</strong> record a <code>migrationTarget</code> for the default database (usually <code>neo4j</code>),
so that this feature doesn&#8217;t break compatibility with schemas created before 1.1.0.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
It is usually a good idea to separate management data (like in this case the chain of applied migrations) from you own data,
     whether the latter is created or changed by refactorings itself or by an application). So we recommend to use separated databases when
     you&#8217;re on enterprise edition.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="concepts_transactions"><a class="anchor" href="#concepts_transactions"></a>3.9. Transactions</h3>
<div class="paragraph">
<p>All operations that are managed by Neo4j-Migrations directly, except catalog-based migrations, are executed
inside transactional functions. This is essentially a scope around one or more statements which will be retried on
certain conditions (for example, on losing connectivity inside a cluster setup).</p>
</div>
<div class="paragraph">
<p>You can configure if all statements of one <a href="#concepts_migrations_cypher-based">Cypher-based</a> migration go into one
transactional function or if each statement goes into its own transactional scope:</p>
</div>
<div class="listingblock">
<div class="title">Listing 17. Choose transaction behaviour</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MigrationsConfig configPerMigration = MigrationsConfig.builder()
    .withTransactionMode(MigrationsConfig.TransactionMode.PER_MIGRATION)
    .build();

<span class="comment">// OR</span>

MigrationsConfig configPerStatement = MigrationsConfig.builder()
    .withTransactionMode(MigrationsConfig.TransactionMode.PER_STATEMENT)
    .build();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Per Migration is the default, as we think it&#8217;s safer:
Either the whole migration is applied (or failed) or none.
But there are certain scenarios that require a transaction per statement, for example most DDL operations such as creating
databases might not be run together with DML operations in the same transaction.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<a href="#concepts_catalog">Catalog-based migrations</a> - that is creation of indexes and constraints through the dedicated
         Neo4j-Migrations API - are always executed inside auto-commit transactions, as the underlying connectivity has some
         deficiencies that don&#8217;t allow retries or continuing using a transaction in some failure conditions that might happen
         during the creation of schema items.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="concepts_preconditions"><a class="anchor" href="#concepts_preconditions"></a>3.10. Preconditions</h3>
<div class="paragraph">
<p>Our <a href="#concepts_migrations_cypher-based">Cypher based migrations</a> support a set of simple assertions and assumptions as preconditions
prior to execution.</p>
</div>
<div class="paragraph">
<p>Preconditions can be added as a single-line Cypher comment to a script. Multiple preconditions in one script must all be
met (logically chained with <code>AND</code>).</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Assertions</dt>
<dd>
<p>Preconditions starting with <code>// assert</code> are hard requirements. If they cannot be satisfied by the target database, Neo4j-Migrations
will abort.</p>
</dd>
<dt class="hdlist1">Assumptions</dt>
<dd>
<p>Preconditions starting with <code>// assume</code> are soft requirements. If they cannot be satisfied, the corresponding script will be skipped
and not be part of any chain.</p>
</dd>
</dl>
</div>
<div id="multiple-assumptions" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
If you think that preconditions might change (for example when asking for a specific version):
Make sure you have alternative scripts with the same filename available, both having preconditions meeting
the matching cases. We will treat them as alternatives and make sure that a changed checksum is not treated as
an error. For example this would happen if you suddenly one migration has its precondition met which it didn&#8217;t
before and therefore changing the chain of applied migrations.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="requireacertainedition"><a class="anchor" href="#requireacertainedition"></a>3.10.1. Require a certain edition</h4>
<div class="paragraph">
<p>The Neo4j edition can be required with either</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assume that edition is enterprise</code></pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assume that edition is community.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="requireacertainversion"><a class="anchor" href="#requireacertainversion"></a>3.10.2. Require a certain version</h4>
<div class="paragraph">
<p>The Neo4j version can be required with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assume that version is 4.3</code></pre>
</div>
</div>
<div class="paragraph">
<p>Multiple versions can be enumerated after the <code>is</code> separated by a <code>,</code>.</p>
</div>
<div class="paragraph">
<p>Version ranges can be required with <code>lt</code> (lower than) or <code>ge</code> (greater than or equals), for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assume that version is ge 4.0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both assumptions combined makes it safe to use version assumptions (see <a href="#multiple-assumptions">the warning above</a>).
We recommend using one refactoring for the minimum version you support and one for all higher that support the feature you
want. For example: Your minimum supported database version is 4.3 and you want to create an existential constraint.
You want to have 2 migrations:</p>
</div>
<div class="listingblock">
<div class="title">Listing 18. 43/V0001__Create_existence_constraint.cypher</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assert that edition is enterprise
// assume that version is 4.3
CREATE CONSTRAINT isbn_exists IF NOT EXISTS ON (book:Library) ASSERT exists(book.isbn);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the different one for 4.4 or higher:</p>
</div>
<div class="listingblock">
<div class="title">Listing 19. 44/V0001__Create_existence_constraint.cypher</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assert that edition is enterprise
// assume that version is ge 4.4
CREATE CONSTRAINT isbn_exists IF NOT EXISTS FOR (book:Library) REQUIRE book.isbn IS NOT NULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The former will only applied to the 4.3, the latter to 4.4 or higher. If your user upgrades their
database at some point, Neo4j-Migrations will recognize that it used an older, compatible script
with it and wont fail, even though the new script has a different checksum.</p>
</div>
</div>
<div class="sect3">
<h4 id="preconditionsbasedoncypherqueries"><a class="anchor" href="#preconditionsbasedoncypherqueries"></a>3.10.3. Preconditions based on Cypher queries</h4>
<div class="paragraph">
<p>You can require a precondition based on a query that must return a single, <code>boolean</code> value via</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assume q' RETURN true</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above case will of course always be satisfied.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a complete example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">// assert that edition is enterprise
// assert that version is 4.4
// assume q' MATCH (book:Library) RETURN count(book) = 0
CREATE CONSTRAINT isbn_exists IF NOT EXISTS FOR (book:Library) REQUIRE book.isbn IS NOT NULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This refactoring will only execute on Neo4j 4.4 enterprise (due to the requirements of existence constraints and the 4.4 syntax being used)
and will be ignored when there are already nodes labeled <code>Library</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="whyonlypreconditionsforscripts"><a class="anchor" href="#whyonlypreconditionsforscripts"></a>3.10.4. Why only preconditions for scripts?</h4>
<div class="paragraph">
<p>Since we offer <a href="#concepts_migrations_java-based">full programmatic access</a> to migrations
together with the context that has information about the Neo4j version, edition and access to both target and schema database,
it would be duplicate work if we take the decision away from you. You are completely free inside a programmatic refactoring
not to do anything in a given context. The migration will be dutifully recorded nevertheless.</p>
</div>
</div>
<div class="sect3">
<h4 id="upgradingolderdatabase"><a class="anchor" href="#upgradingolderdatabase"></a>3.10.5. Upgrading older database</h4>
<div class="paragraph">
<p>Given that your application needs to support multiple versions of Neo4j, including versions that didn&#8217;t exist when you created
your application originally and you might have invalid Cypher now in potentially already applied migrations you can do the following</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create sub-folders in your migration locations or configure additional locations</p>
</li>
<li>
<p>Duplicate the migrations that contain Cypher that is problematic in newer Neo4j versions</p>
</li>
<li>
<p>Keep the names of the migrations identical and distribute them accordingly in these folders</p>
</li>
<li>
<p>Add a precondition matching only older versions of Neo4j to one and keep the rest unaltered</p>
</li>
<li>
<p>Adapt the other one containing only "good" syntax and add a precondition for the newer Neo4j version</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus, you support the following scenarios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>On older database versions against which your application already ran, nothing will change; the migration with the fixed syntax will be skipped</p>
</li>
<li>
<p>Same for a clean slate on older database versions</p>
</li>
<li>
<p>On the newer database version, only the fixed syntax migration will be applied.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="concepts_repairing_broken_chains"><a class="anchor" href="#concepts_repairing_broken_chains"></a>3.11. Repairing migrations</h3>
<div class="paragraph">
<p>Sometimes things will break, either on purpose or by accident. When a migration chain is broken, it will fail to validate. This can happen for various reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You change a Cypher script file after it has been applied and its application has been successfully recorded</p>
</li>
<li>
<p>You migrate your database as part of your application startup and not with a CI process and used different versions of your application with a different set of migration scripts and classes</p>
</li>
<li>
<p>You delete individual script files or classes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In all those cases, the chain of applied migrations won&#8217;t validate with the current set of migrations discovered. Apart from using the <a href="#usage_common_clean"><code>clean</code> operation</a> which would remove the whole chain from your database inevitably leading to all migrations to be re-applied, you have several options to repair your database:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Delete the offending migrations - those are all for which no script or class can be resolved anymore - individually from the database with the <a href="#usage_common_delete"><code>delete</code> operation</a>.</p>
</li>
<li>
<p>Use the <a href="#usage_common_repair"><code>repair</code> operation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>repair</code> operation behaves as follows:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check all the checksums (pairwise by migration version) and fix the recorded chain if necessary</p>
</li>
<li>
<p>Check for missing local migrations and delete the missing ones in the database</p>
</li>
<li>
<p>Check for inserted local migrations and create new chain entries with current time stamp</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Especially the second step has consequences: If there aren&#8217;t any local migrations all recorded migrations would be deleted. As misconfigurations can happen (for example during a typo in a path), the <code>repair</code> operation will abort if it doesn&#8217;t find any local migrations. If you want to clean up the database, use the <a href="#usage_common_clean"><code>clean</code> operation</a> explicitly.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
The <code>repair</code> operation will <strong>never</strong> apply any migration. Everything it does is fixing the chain of recorded application. Basically it pretends that everything that has been discovered locally has been applied to the database so that you can start on a clean slate.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As the <code>repair</code> command won&#8217;t apply migrations itself, it will stop after the last applied migration. An example: You have 3 local migrations, v1*, v3 and v4. The chain recorded however is  <code>(v1) &#8594; (v2) &#8594; (v3)</code>. This means, v1 has changed, it&#8217;s checksum doesn&#8217;t match, v2 has been deleted and v4 is new. The repair command will now fix the checksum, delete v2 and then stop, so that the chain now is this: <code>(v1*) &#8594; (v3)</code>. v4 can be applied now with the standard <code>apply</code> operation.</p>
</div>
<div class="sect3">
<h4 id="example"><a class="anchor" href="#example"></a>3.11.1. Example</h4>
<div class="paragraph">
<p>Given the following scenario:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j-migrations -uneo4j -pverysecret --location=file:$MIGRATIONS info

neo4j@localhost:7687 (Neo4j/5.4.0 Community Edition)
Database: neo4j

+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+
| Version | Description                | Type    | Installed on                  | by            | Execution time | State   | Source                                      |
+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+
| 007     | BondTheNameIsBond          | CYPHER  | 2023-03-06T10:55:07.971Z[UTC] | msimons/neo4j | PT0.041S       | APPLIED | V007__BondTheNameIsBond.cypher              |
| 007.1   | BondTheNameIsBondNew       | CYPHER  | 2023-03-06T10:55:08.059Z[UTC] | msimons/neo4j | PT0.018S       | APPLIED | V007_1__BondTheNameIsBondNew.cypher         |
| 007.1.1 | BondTheNameIsBondNewNew    | CYPHER  | 2023-03-06T10:55:08.144Z[UTC] | msimons/neo4j | PT0.034S       | APPLIED | V007_1_1__BondTheNameIsBondNewNew.cypher    |
| 008     | Create constraints         | CATALOG | 2023-03-06T10:55:08.186Z[UTC] | msimons/neo4j | PT0.02S        | APPLIED | V008__Create_constraints.xml                |
| 021     | Die halbe Wahrheit         | CYPHER  | 2023-03-06T10:55:08.253Z[UTC] | msimons/neo4j | PT0.035S       | APPLIED | V021__Die halbe Wahrheit.cypher             |
| 021.1   | Die halbe Wahrheit neu     | CYPHER  | 2023-03-06T10:55:08.304Z[UTC] | msimons/neo4j | PT0.011S       | APPLIED | V021.1__Die halbe Wahrheit neu.cypher       |
| 021.1.1 | Die halbe Wahrheit neu neu | CYPHER  | 2023-03-06T10:55:08.320Z[UTC] | msimons/neo4j | PT0.005S       | APPLIED | V021.1.1__Die halbe Wahrheit neu neu.cypher |
| 4711    | MirFallenKeineNamenEin     | CYPHER  | 2023-03-06T10:55:08.346Z[UTC] | msimons/neo4j | PT0.016S       | APPLIED | V4711__MirFallenKeineNamenEin.cypher        |
| 5000    | WithCommentAtEnd           | CYPHER  | 2023-03-06T10:55:08.372Z[UTC] | msimons/neo4j | PT0.015S       | APPLIED | V5000__WithCommentAtEnd.cypher              |
| 5002    | AMigration                 | CATALOG | 2023-03-06T10:55:08.382Z[UTC] | msimons/neo4j | PT0S           | APPLIED | V5002__AMigration.xml                       |
+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following local changes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">rm $MIGRATIONS/moreStuff/V007__BondTheNameIsBond.cypher
echo &quot;CREATE (n:IWasHere)&quot; &gt;&gt; $MIGRATIONS/V021__Die\ halbe\ Wahrheit.cypher
echo &quot;CREATE (n:IWasHere)&quot; &gt;&gt; $MIGRATIONS/V5001__ANewMigration.cypher
echo &quot;CREATE (n:IWasHere)&quot; &gt;&gt; $MIGRATIONS/V5003__AnotherNewMigration.cypher</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, trying to re-apply all migrations will fail:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j-migrations -uneo4j -pverysecret --location=file:$MIGRATIONS apply
[2023-03-06T11:59:23.780439000] Invoked beforeMigrate callback.
[2023-03-06T11:59:23.807065000] Invoked afterMigrate callback.
Unexpected migration at index 0: 007.1 (&quot;BondTheNameIsBondNew&quot;).</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>info</code> command will fail with the same error. The chain can be repaired like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j-migrations -uneo4j -pverysecret --location=file:$MIGRATIONS repair
The migration chain in the default database has been repaired: 1 nodes and 3 relationships have been deleted, 1 nodes and 3 relationships have been recreated.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result looks like this</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j-migrations -uneo4j -pverysecret --location=file:$MIGRATIONS info

neo4j@localhost:7687 (Neo4j/5.4.0 Community Edition)
Database: neo4j

+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+
| Version | Description                | Type    | Installed on                  | by            | Execution time | State   | Source                                      |
+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+
| 007.1   | BondTheNameIsBondNew       | CYPHER  | 2023-03-06T10:55:07.971Z[UTC] | msimons/neo4j | PT0.041S       | APPLIED | V007_1__BondTheNameIsBondNew.cypher         |
| 007.1.1 | BondTheNameIsBondNewNew    | CYPHER  | 2023-03-06T10:55:08.144Z[UTC] | msimons/neo4j | PT0.034S       | APPLIED | V007_1_1__BondTheNameIsBondNewNew.cypher    |
| 008     | Create constraints         | CATALOG | 2023-03-06T10:55:08.186Z[UTC] | msimons/neo4j | PT0.02S        | APPLIED | V008__Create_constraints.xml                |
| 021     | Die halbe Wahrheit         | CYPHER  | 2023-03-06T10:55:08.253Z[UTC] | msimons/neo4j | PT0.035S       | APPLIED | V021__Die halbe Wahrheit.cypher             |
| 021.1   | Die halbe Wahrheit neu     | CYPHER  | 2023-03-06T10:55:08.304Z[UTC] | msimons/neo4j | PT0.011S       | APPLIED | V021.1__Die halbe Wahrheit neu.cypher       |
| 021.1.1 | Die halbe Wahrheit neu neu | CYPHER  | 2023-03-06T10:55:08.320Z[UTC] | msimons/neo4j | PT0.005S       | APPLIED | V021.1.1__Die halbe Wahrheit neu neu.cypher |
| 4711    | MirFallenKeineNamenEin     | CYPHER  | 2023-03-06T10:55:08.346Z[UTC] | msimons/neo4j | PT0.016S       | APPLIED | V4711__MirFallenKeineNamenEin.cypher        |
| 5000    | WithCommentAtEnd           | CYPHER  | 2023-03-06T10:55:08.372Z[UTC] | msimons/neo4j | PT0.015S       | APPLIED | V5000__WithCommentAtEnd.cypher              |
| 5001    | ANewMigration              | CYPHER  | 2023-03-06T11:00:39.311Z[UTC] | msimons/neo4j | PT0S           | APPLIED | V5001__ANewMigration.cypher                 |
| 5002    | AMigration                 | CATALOG | 2023-03-06T10:55:08.382Z[UTC] | msimons/neo4j | PT0S           | APPLIED | V5002__AMigration.xml                       |
| 5003    | AnotherNewMigration        | CYPHER  |                               |               |                | PENDING | V5003__AnotherNewMigration.cypher           |
+---------+----------------------------+---------+-------------------------------+---------------+----------------+---------+---------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>007</code> has been deleted, checksum of <code>021</code> has been fixed, <code>5001</code> has been inserted and <code>5003</code> is still pending.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="usage"><a class="anchor" href="#usage"></a>4. Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="usage_common"><a class="anchor" href="#usage_common"></a>4.1. Common operations</h3>
<div class="sect3">
<h4 id="usage_common_clean"><a class="anchor" href="#usage_common_clean"></a>4.1.1. Clean</h4>
<div class="paragraph">
<p><code>clean</code> applies by default to the <a href="#concepts_separate-databases">schema database</a>.
It will remove Neo4j-Migrations related nodes and relationships.
If there is no schema database selected, it works on the optional target database.
If this isn&#8217;t configured either, the users home database will be used.</p>
</div>
<div class="paragraph">
<p>The clean operation will search for</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Migration chains (those are the nodes containing information about the applied migrations)</p>
</li>
<li>
<p>Any log from this Neo4j-Migrations</p>
</li>
<li>
<p>Any constraints created by Neo4j-Migrations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and will delete and drop them in that order.
This is a <strong>destructive</strong> operation, so make sure not to apply it to your production database without thinking at least twice.
It cannot be undone via Neo4j-Migrations.</p>
</div>
<div class="paragraph">
<p>The operation takes in a boolean parameter.
When set to <code>false</code>, only the <a href="#concepts_chain">migration chain</a> for the currently configured target database will be deleted.
When set to <code>true</code>, all objects created by Neo4j-Migrations will be deleted.</p>
</div>
</div>
<div class="sect3">
<h4 id="usage_common_delete"><a class="anchor" href="#usage_common_delete"></a>4.1.2. Delete</h4>
<div class="paragraph">
<p>The <code>delete</code> operation comes in handy when the migrations fail to <a href="#usage_common_validate">validate</a>. This might be the case when you accidentally or on purpose deleted script files or refactored Java based migrations away. The <code>delete</code> operation takes in the unique version or the name of a Cypher script file or a Java class, looks for a migration in the migration chain fitting that description and deletes it. If it was the last migration in the chain, the previous one will be the new last, otherwise the previous migration will point to the next one.</p>
</div>
<div class="paragraph">
<p>Using the <code>delete</code> operation is one way of <a href="#concepts_repairing_broken_chains">repairing broken migration chains</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="usage_common_info"><a class="anchor" href="#usage_common_info"></a>4.1.3. Info</h4>
<div class="paragraph">
<p>The <code>info</code> operations returns information about the context, the database, all applied and all pending applications.</p>
</div>
</div>
<div class="sect3">
<h4 id="usage_common_migrate"><a class="anchor" href="#usage_common_migrate"></a>4.1.4. Migrate / apply</h4>
<div class="paragraph">
<p>The <code>migrate</code> command (or its underlying method <code>apply</code> in the Migrations Core API) does exactly that:
It applies all locally resolved migrations to the target database and stores the <a href="#concepts_chain">chain of applied migrations</a> in the schema database.</p>
</div>
<div class="paragraph">
<p>It returns the last applied version.</p>
</div>
<div class="paragraph">
<p>That operation does not allow migrations out-of-order by default.
That means if you add version 2 after you already migrated to 5, it will fail with an appropriate error.
You can spot these cases beforehand by validating your chain of migrations (see below).
If you absolutely must however, you can use <code>withOutOfOrderAllowed</code> on the config object or the corresponding property in either the Spring Boot starter or the Quarkus extension.
Setting this to true will integrate out-of-order migrations into the chain.</p>
</div>
<div class="paragraph">
<p>By default, all migrations will be applied.
However, you can configure a target version to stop at.
The target version will always be an <strong>inclusive</strong> stop.
This is especially important for repeatable migrations: If the target is repeatable and has changed since the last application, it will be applied again.
The target version must be an exact version number as given with the file- or classname (such as <code>V1_2_3</code>, <code>R010</code>, <code>V100</code> or whatever scheme you use), specifying the description again is not necessary (See ref:concepts.adoc#concepts_naming-conventions[naming conventions]).
Migrations does check whether the target version can be resolved and will abort if there is no such version, either in pending or applied state).
You can use <code>V010?</code> (with a question mark) to skip this check.
Migrations will then apply every version that is sorted below that version.
Additionally, three special values are supported as well (These names are case-insensitive):</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>current</code></dt>
<dd>
<p>Designates the current version of the schema.</p>
</dd>
<dt class="hdlist1"><code>latest</code></dt>
<dd>
<p>The latest version of the schema, as defined by the migration with the highest version.</p>
</dd>
<dt class="hdlist1"><code>next</code></dt>
<dd>
<p>The next version of the schema, as defined by the first pending migration.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="usage_common_repair"><a class="anchor" href="#usage_common_repair"></a>4.1.5. Repair</h4>
<div class="paragraph">
<p>The <code>repair</code> operation is an emergency operation for all those cases in which</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Local migrations have been changed (incidentally or on purpose) so that their checksums now mismatch</p>
</li>
<li>
<p>Local migrations are deleted</p>
</li>
<li>
<p>Applying migrations failed for whatever reasons</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>so that the chain of applied migrations does not fit with the discovered migrations anymore. This operation will fix checksums, automatically <a href="#usage_common_delete">delete</a> locally missing migrations from the chain and insert placeholder migrations into the chain if necessary. It does stop at the end of the chain (all migrations discovered after that can be applied with <a href="#usage_common_migrate">apply</a> in the regular way), <strong>does not</strong> apply migrations itself after the fact and will fail hard in case no local migrations can be found (if this is the case, use <a href="#usage_common_clean">clean</a> to remove all recorded migrations.)</p>
</div>
</div>
<div class="sect3">
<h4 id="usage_common_validate"><a class="anchor" href="#usage_common_validate"></a>4.1.6. Validate</h4>
<div class="paragraph">
<p>The <code>validate</code> operations resolves all local migrations and checks whether all have applied in the same order and in the
same version to the configured database.
A target database will validate as valid when all migrations have been applied in the right order and invalid in any cases
where migrations are missing, have not been applied, applied in a different order or with a different checksum.</p>
</div>
<div class="paragraph">
<p>The validation result provides an additional operation <code>needsRepair()</code>.
In case the result is invalid you might check if it needs repair.
If not, you can just call the <a href="#usage_common_migrate">apply operation</a> to turn the database into a valid state.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="cli"><a class="anchor" href="#cli"></a>4.2. CLI</h3>
<div class="paragraph">
<p>Please choose the version of Neo4j-Migrations-CLI fitting your operating system or target system as described in <a href="#download_cli">download</a>.
In the following we assume you downloaded and unzipped the architecture independent version.
For that version to work, you need to have JDK 17 or higher installed:</p>
</div>
<div class="listingblock">
<div class="title">Listing 20. Download and extraction of the JVM based version</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">java -version
curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip
unzip neo4j-migrations-2.20.0.zip
cd neo4j-migrations-2.20.0
./bin/neo4j-migrations -V</code></pre>
</div>
</div>
<div class="paragraph">
<p>Those commands should first print out your Java version, then download, extract and run Neo4j-Migrations-CLI to give you its version.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
If you only deal with <a href="#concepts_migrations_cypher-based">Cypher-based migrations</a> and
      don&#8217;t have the need for any <a href="#concepts_migrations_java-based">programmatic migrations</a>,
      we provide a native binary for your platform, make sure to choose that.
      Its startup time is faster, and you don&#8217;t need to have a JVM installed.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="alloptionsandarguments"><a class="anchor" href="#alloptionsandarguments"></a>4.2.1. All options and arguments</h4>
<div class="paragraph">
<p>The CLI comes with a build-in help, accessible via <code>neo4j-migrations -h</code> or <code>neo4j-migrations --help</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations --help
Usage: neo4j-migrations [-hvV] [--autocrlf] [--validate-on-migrate] -p
                        [=&lt;password&gt;] [-p[=&lt;password&gt;]]... [-a=&lt;address&gt;]
                        [-d=&lt;database&gt;] [--impersonate=&lt;impersonatedUser&gt;]
                        [--schema-database=&lt;schemaDatabase&gt;]
                        [--transaction-mode=&lt;transactionMode&gt;] [-u=&lt;user&gt;]
                        [--location=&lt;locationsToScan&gt;]...
                        [--package=&lt;packagesToScan&gt;]... [COMMAND]
Migrates Neo4j databases.
  -a, --address=&lt;address&gt;   The address this migration should connect to. The
                              driver supports bolt, bolt+routing or neo4j as
                              schemes.
      --autocrlf            Automatically convert Windows line-endings (CRLF)
                              to LF when reading resource based migrations,
                              pretty much what the same Git option does during
                              checkin.
  -d, --database=&lt;database&gt; The database that should be migrated (Neo4j EE 4.0
                              +).
  -h, --help                Show this help message and exit.
      --impersonate=&lt;impersonatedUser&gt;
                            The name of a user to impersonate during migration
                              (Neo4j EE 4.4+).
      --location=&lt;locationsToScan&gt;
                            Location to scan. Repeat for multiple locations.
  -p, --password[=&lt;password&gt;]
                            The password of the user connecting to the database.
      --package=&lt;packagesToScan&gt;
                            Package to scan. Repeat for multiple packages.
      --schema-database=&lt;schemaDatabase&gt;
                            The database that should be used for storing
                              information about migrations (Neo4j EE 4.0+).
      --transaction-mode=&lt;transactionMode&gt;
                            The transaction mode to use.
  -u, --username=&lt;user&gt;     The login of the user connecting to the database.
  -v                        Log the configuration and a couple of other things.
  -V, --version             Print version information and exit.
      --validate-on-migrate Validating helps you verify that the migrations
                              applied to the database match the ones available
                              locally and is on by default.
Commands:
  clean           Removes Neo4j-Migration specific data from the selected
                    schema database.
  delete          Deletes a migration from the chain of applied migrations.
  help            Display help information about the specified command.
  info            Retrieves all applied and pending information, prints them
                    and exits.
  init            Creates a migration project inside the current folder.
  migrate, apply  Retrieves all pending migrations, verify and applies them.
  repair          Compares locally discovered migrations with the remote chain
                    and repairs the remote chain if necessary; no migrations
                    will be applied during this process, only the migration
                    chain will be manipulated. This command requires at least
                    one local migration.
  run             Resolves the specified migrations and applies them. Does not
                    record any metadata.
  show-catalog    Gets the local or remote catalog and prints it to standard
                    out in the given format.
  validate        Resolves all local migrations and validates the state of the
                    configured database with them.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If no values are given to either <code>location</code> or <code>packages</code> we check for a directory structure of <code>neo4j/migrations</code> inside
the current working directory and use that as a default for <code>location</code> if such a structure exists.</p>
</div>
<div class="paragraph">
<p>The <code>info</code> command takes a <code>mode</code> option as an optional argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Usage: neo4j-migrations info [mode=&lt;mode&gt;]
Retrieves all applied and pending informations, prints them and exits.
      mode=&lt;mode&gt;   Controls how the information should be computed. Valid
                      options are COMPARE, LOCAL, REMOTE with COMPARE being the
                      default. COMPARE will always compare locally discovered
                      and remotely applied migrations, while the other options
                      just check what's there.</pre>
</div>
</div>
<div class="paragraph">
<p>This means that we by default compare what has been discovered locally with what has been applied in the database:
We check for missing or superfluous migrations and also compare checksums.
At times, you might want to have just a quick look at what is in the database, without configuring a local filesystem.
Use <code>mode=remote</code> in that case: We just look at what is in the database and assume everything is applied.
Use <code>mode=local</code> to print out what has been discovered locally with the current settings and would be applied to an empty database.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<code>neo4j-migrations</code> looks in the current working directory for a properties file called <code>.migration.properties</code> which
     can contain all supported options. Use such a file to avoid repeating long command lines all the time.
     Use <code>neo4j-migrations init</code> to create a file with the default values. Any options passed to <code>neo4j-migrations</code> before
     the init command will also be store.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="output"><a class="anchor" href="#output"></a>4.2.2. Output</h4>
<div class="paragraph">
<p>Direct information coming from the CLI itself will always go to standard out. Information coming from core migrations
will be locked with a timestamp on standard error. This allows for controlled redirection of different information.</p>
</div>
</div>
<div class="sect3">
<h4 id="safepasswordsincicdusage"><a class="anchor" href="#safepasswordsincicdusage"></a>4.2.3. Safe passwords in CI/CD usage</h4>
<div class="paragraph">
<p>There are 4 ways to specify the password:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>interactive: Use <code>--password</code> without arguments and your shell will prompt you with a hidden prompt.</p>
</li>
<li>
<p>direct: Use <code>--password not-so-secret</code>. The password will be visible in the shell history and in the process monitor.</p>
</li>
<li>
<p>Via environment variable: Define an environment variable like <code>MY_PASSWORD</code> and use <code>--password:env MY_PASSWORD</code>. Note
that the parameter is the <strong>name</strong>  of the variable, not the resolved value.</p>
</li>
<li>
<p>Via a file: Create a file in a safe space and add your password in a single line in that file and use <code>--password:file path/to/your/passwordFile</code>.
The password will be read from this file.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The last two options are a safe choice in scripts or in a CI/CD environment.</p>
</div>
</div>
<div class="sect3">
<h4 id="well-knownneo4jenvironmentvariables"><a class="anchor" href="#well-knownneo4jenvironmentvariables"></a>4.2.4. Well-known Neo4j environment variables</h4>
<div class="paragraph">
<p>Neo4j AuraDB provides <code>.env</code> files when creating new instances that look like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 21. A Neo4j AuraDB .env file</div>
<div class="content">
<pre class="CodeRay highlight"><code># Wait 60 seconds before connecting using these details, or login to https://console.neo4j.io to validate the Aura Instance is available
NEO4J_URI=neo4j+s://xxxx.databases.neo4j.io
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=somepassword
AURA_INSTANCENAME=Instance01</code></pre>
</div>
</div>
<div class="paragraph">
<p>Neo4j-Migrations will recognize those environment variables when present.
If you didn&#8217;t specify a value for username, password or address and those variables are present and not empty, Neo4j-Migrations will use them.</p>
</div>
<div class="paragraph">
<p>Above file can be directly used in a command like this (on a *Nix-system):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">set -o allexport <i class="conum" data-value="1"></i><b>(1)</b>
(source ~/Downloads/credentials-xxx.env; neo4j-migrations info)
set +o allexport</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Might not be needed in your shell</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="enableautocompletionforneo4j-migrationsinyourshell"><a class="anchor" href="#enableautocompletionforneo4j-migrationsinyourshell"></a>4.2.5. Enable autocompletion for Neo4j-Migrations in your shell</h4>
<div class="paragraph">
<p>Neo4j-Migrations can generate a shell script providing autocompletion for its options in Bash, zsh and others.
Here&#8217;s how to use it:</p>
</div>
<div class="listingblock">
<div class="title">Listing 22. Generate autocompletion script</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations generate-completion &gt; neo4j-migrations_completion.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>The generated script <code>neo4j-migrations_completion.sh</code> can than be run via <code>. neo4j-migrations_completion.sh</code> or permanently installed by
sourcing it in your <code>~/.bashrc</code> or <code>~/.zshrc</code>.</p>
</div>
<div class="paragraph">
<p>If you want to have autocompletion for Neo4j-Migrations just in your current shell use the following command</p>
</div>
<div class="listingblock">
<div class="title">Listing 23. Add autocompletion to your current shell</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">source &lt;(./bin/neo4j-migrations generate-completion)</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Autocompletion for macOS is automatically installed when you use <a href="#download_cli_brew">Homebrew</a>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="fullexample"><a class="anchor" href="#fullexample"></a>4.2.6. Full example</h4>
<div class="paragraph">
<p>Here&#8217;s an example that looks for migrations in a Java package, its subpackages and in a filesystem location for Cypher-based migrations.
In this example we have exported the directory with our Java-based migrations like this: <code>export CLASSPATH_PREFIX=~/Projects/neo4j-migrations/neo4j-migrations-core/target/test-classes/</code>.
Please adapt accordingly to your project and / or needs.</p>
</div>
<div class="paragraph">
<p>The example uses the <code>info</code> command to tell you which migrations have been applied and which not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  --location file:$HOME/Desktop/foo \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset1 \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset2 \
  info

neo4j@localhost:7687 (Neo4j/4.4.0)
Database: neo4j

+---------+-----------------------------+--------+--------------+----+----------------+---------+--------------------------------------------------------------+
| Version | Description                 | Type   | Installed on | by | Execution time | State   | Source                                                       |
+---------+-----------------------------+--------+--------------+----+----------------+---------+--------------------------------------------------------------+
| 001     | FirstMigration              | JAVA   |              |    |                | PENDING | a.s.n.m.c.t.changeset1.V001__FirstMigration                  |
| 002     | AnotherMigration            | JAVA   |              |    |                | PENDING | a.s.n.m.c.t.changeset1.V002__AnotherMigration                |
| 023     | NichtsIstWieEsScheint       | JAVA   |              |    |                | PENDING | a.s.n.m.c.t.changeset2.V023__NichtsIstWieEsScheint           |
| 023.1   | NichtsIstWieEsScheintNeu    | JAVA   |              |    |                | PENDING | a.s.n.m.c.t.changeset2.V023_1__NichtsIstWieEsScheintNeu      |
| 023.1.1 | NichtsIstWieEsScheintNeuNeu | JAVA   |              |    |                | PENDING | a.s.n.m.c.t.changeset2.V023_1_1__NichtsIstWieEsScheintNeuNeu |
| 030     | Something based on a script | CYPHER |              |    |                | PENDING | V030__Something_based_on_a_script.cypher                     |
| 042     | The truth                   | CYPHER |              |    |                | PENDING | V042__The_truth.cypher                                       |
+---------+-----------------------------+--------+--------------+----+----------------+---------+--------------------------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can repeat both <code>--package</code>  and <code>--location</code> parameter for fine-grained control.
Use <code>migrate</code> to apply migrations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  --location file:$HOME/Desktop/foo \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset1 \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset2 \
  migrate
[2022-05-31T11:25:29.894372000] Applied migration 001 (&quot;FirstMigration&quot;).
[2022-05-31T11:25:29.985192000] Applied migration 002 (&quot;AnotherMigration&quot;).
[2022-05-31T11:25:30.001006000] Applied migration 023 (&quot;NichtsIstWieEsScheint&quot;).
[2022-05-31T11:25:30.016117000] Applied migration 023.1 (&quot;NichtsIstWieEsScheintNeu&quot;).
[2022-05-31T11:25:30.032421000] Applied migration 023.1.1 (&quot;NichtsIstWieEsScheintNeuNeu&quot;).
[2022-05-31T11:25:30.056182000] Applied migration 030 (&quot;Something based on a script&quot;).
[2022-05-31T11:25:30.077719000] Applied migration 042 (&quot;The truth&quot;).
Database migrated to version 042.</code></pre>
</div>
</div>
<div class="paragraph">
<p>If we go back to the <code>info</code> example above and grab all migrations again, we find the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  --location file:$HOME/Desktop/foo \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset1 \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset2 \
  info

Database: Neo4j/4.0.0@localhost:7687

+---------+-----------------------------+--------+-------------------------------+---------------+----------------+---------+--------------------------------------------------------------+
| Version | Description                 | Type   | Installed on                  | by            | Execution time | State   | Source                                                       |
+---------+-----------------------------+--------+-------------------------------+---------------+----------------+---------+--------------------------------------------------------------+
| 001     | FirstMigration              | JAVA   | 2021-12-14T12:16:43.577Z[UTC] | msimons/neo4j | PT0S           | APPLIED | a.s.n.m.c.t.changeset1.V001__FirstMigration                  |
| 002     | AnotherMigration            | JAVA   | 2021-12-14T12:16:43.876Z[UTC] | msimons/neo4j | PT0.032S       | APPLIED | a.s.n.m.c.t.changeset1.V002__AnotherMigration                |
| 023     | NichtsIstWieEsScheint       | JAVA   | 2021-12-14T12:16:43.993Z[UTC] | msimons/neo4j | PT0S           | APPLIED | a.s.n.m.c.t.changeset2.V023__NichtsIstWieEsScheint           |
| 023.1   | NichtsIstWieEsScheintNeu    | JAVA   | 2021-12-14T12:16:44.014Z[UTC] | msimons/neo4j | PT0S           | APPLIED | a.s.n.m.c.t.changeset2.V023_1__NichtsIstWieEsScheintNeu      |
| 023.1.1 | NichtsIstWieEsScheintNeuNeu | JAVA   | 2021-12-14T12:16:44.035Z[UTC] | msimons/neo4j | PT0S           | APPLIED | a.s.n.m.c.t.changeset2.V023_1_1__NichtsIstWieEsScheintNeuNeu |
| 030     | Something based on a script | CYPHER | 2021-12-14T12:16:44.093Z[UTC] | msimons/neo4j | PT0.033S       | APPLIED | V030__Something_based_on_a_script.cypher                     |
| 042     | The truth                   | CYPHER | 2021-12-14T12:16:44.127Z[UTC] | msimons/neo4j | PT0.011S       | APPLIED | V042__The truth.cypher                                       |
+---------+-----------------------------+--------+-------------------------------+---------------+----------------+---------+--------------------------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>Another <code>migrate</code> - this time with all packages - gives us the following output and result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  --location file:$HOME/Desktop/foo \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset1 \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset2 \
  migrate
[2022-05-31T11:26:23.054169000] Skipping already applied migration 001 (&quot;FirstMigration&quot;)
[2022-05-31T11:26:23.058779000] Skipping already applied migration 002 (&quot;AnotherMigration&quot;)
[2022-05-31T11:26:23.059185000] Skipping already applied migration 023 (&quot;NichtsIstWieEsScheint&quot;)
[2022-05-31T11:26:23.059504000] Skipping already applied migration 023.1 (&quot;NichtsIstWieEsScheintNeu&quot;)
[2022-05-31T11:26:23.059793000] Skipping already applied migration 023.1.1 (&quot;NichtsIstWieEsScheintNeuNeu&quot;)
[2022-05-31T11:26:23.060068000] Skipping already applied migration 030 (&quot;Something based on a script&quot;)
[2022-05-31T11:26:23.060329000] Skipping already applied migration 042 (&quot;The truth&quot;)
Database migrated to version 042.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The database will be now in a valid state:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  --location file:$HOME/Desktop/foo \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset1 \
  --package ac.simons.neo4j.migrations.core.test_migrations.changeset2 \
  validate
All resolved migrations have been applied to the default database.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="usingthecliasascriptrunner"><a class="anchor" href="#usingthecliasascriptrunner"></a>4.2.7. Using the CLI as a script runner</h4>
<div class="paragraph">
<p>The CLI can be used as a simple runner for migrations scripts as well. The only necessity is that all scripts have well-defined names according to the format described <a href="#concepts_migrations">here</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">./bin/neo4j-migrations -uneo4j -psecret \
  run \
  --migration file:`pwd`/../../../neo4j-migrations-core/src/test/resources/manual_resources/V000__Create_schema.cypher \
  --migration file:`pwd`/../../../neo4j-migrations-core/src/test/resources/manual_resources/V000__Create_graph.cypher \
  --migration file:`pwd`/../../../neo4j-migrations-core/src/test/resources/manual_resources/V000__Refactor_graph.xml
[2022-09-27T17:24:11.589274000] Applied 000 (&quot;Create graph&quot;)
[2022-09-27T17:24:11.860457000] Applied 000 (&quot;Refactor graph&quot;)
Applied 2 migration(s).</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You can specify as many resources as you want. They will be applied in order. No checks will be done whether they have already been applied or not and no metadata will be recored.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="atemplateforjava-basedmigrations"><a class="anchor" href="#atemplateforjava-basedmigrations"></a>4.2.8. A template for Java-based migrations</h4>
<div class="paragraph">
<p>As stated above, this will work only with the JVM distribution.
Follow those steps:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip
unzip neo4j-migrations-2.20.0.zip
cd neo4j-migrations-2.20.0
mkdir -p my-migrations/some/migrations
cat &lt;&lt;EOT &gt;&gt; my-migrations/some/migrations/V001__MyFirstMigration.java
package some.migrations;

import ac.simons.neo4j.migrations.core.JavaBasedMigration;
import ac.simons.neo4j.migrations.core.MigrationContext;

import org.neo4j.driver.Driver;
import org.neo4j.driver.Session;

public class V001__MyFirstMigration implements JavaBasedMigration {

    @Override
    public void apply(MigrationContext context) {
        try (Session session = context.getSession()) {
        }
    }
}
EOT
javac -cp &quot;lib/*&quot; my-migrations/some/migrations/*
CLASSPATH_PREFIX=my-migrations ./bin/neo4j-migrations -v -uneo4j -psecret --package some.migrations info</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
We do add this here for completeness, but we do think that Java-based migrations makes most sense from inside your application,
      regardless whether it&#8217;s a Spring Boot, Quarkus or just a plain Java application.
      The CLI should be seen primarily as a script runner.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_core"><a class="anchor" href="#usage_core"></a>4.3. Core API</h3>
<div class="paragraph">
<p>We publish the Java-API-Docs here: <a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations/apidocs/index.html">Neo4j Migrations (Core) 2.20.0 API</a>.
Follow the instructions for your favorite dependency management tool to get hold of the core API as described in <a href="#download_core">download</a>.</p>
</div>
<div class="paragraph">
<p>The classes you will be working with are <code>ac.simons.neo4j.migrations.core.MigrationsConfig</code> and its related builder and
<code>ac.simons.neo4j.migrations.core.Migrations</code> and maybe <code>ac.simons.neo4j.migrations.core.JavaBasedMigration</code> in case you
want to do programmatic refactorings.</p>
</div>
<div class="sect3">
<h4 id="configurationandusage"><a class="anchor" href="#configurationandusage"></a>4.3.1. Configuration and usage</h4>
<div class="paragraph">
<p>Configuration is basically made up of two parts:
Creating a driver instance that points to your database or cluster as described in the <a href="#concepts_connectivity">Connectivity section</a> and an instance of <code>MigrationsConfig</code>.
An instance of <code>MigrationsConfig</code> is created via a fluent-builder API.
Putting everything together looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 24. Creating an instance of <code>Migrations</code> based on a configuration object and the Java driver</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Migrations migrations = <span class="keyword">new</span> Migrations(
    MigrationsConfig.builder()
        .withPackagesToScan(<span class="string"><span class="delimiter">&quot;</span><span class="content">some.migrations</span><span class="delimiter">&quot;</span></span>)
        .withLocationsToScan(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">classpath:my/awesome/migrations</span><span class="delimiter">&quot;</span></span>,
            <span class="string"><span class="delimiter">&quot;</span><span class="content">file:/path/to/migration</span><span class="delimiter">&quot;</span></span>
        )
        .build(),
    GraphDatabase.driver(<span class="string"><span class="delimiter">&quot;</span><span class="content">bolt://localhost:7687</span><span class="delimiter">&quot;</span></span>, AuthTokens.basic(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">secret</span><span class="delimiter">&quot;</span></span>))
);

migrations.apply(); <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Applies this migration object and migrates the database</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In case anything goes wrong the API will throw a <code>ac.simons.neo4j.migrations.core.MigrationsException</code>.
Of course your migrations will be recorded as a chain of applied migrations (as nodes with the label <code>__Neo4jMigration</code>) as well when you use the API directly.</p>
</div>
<div class="paragraph">
<p>The following operations are available:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">clean</dt>
<dd>
<p>Cleans the selected schema database from every metadata created by this tool</p>
</dd>
<dt class="hdlist1">delete</dt>
<dd>
<p>Removes a single migration from the chain of applied migrations</p>
</dd>
<dt class="hdlist1">info</dt>
<dd>
<p>Returns information about the context, the database, all applied and all pending applications</p>
</dd>
<dt class="hdlist1">apply</dt>
<dd>
<p>Applies all discovered migrations</p>
</dd>
<dt class="hdlist1">repair</dt>
<dd>
<p>Repairs the chain of applied migrations without applying pending or reapplying local migrations</p>
</dd>
<dt class="hdlist1">run</dt>
<dd>
<p>Runs a single script without recording it as a migration in the chain of applied migrations</p>
</dd>
<dt class="hdlist1">validate</dt>
<dd>
<p>Validates the database against the resolved migrations</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>All operations are available in the CLI and Maven-Plugin, except for the <code>delete</code> and <code>run</code> operations, which are only in the Core-API and the CLI.
The corresponding starter for Spring Boot respectively the Quarkus extension will automatically run <code>apply</code>.</p>
</div>
<div class="paragraph">
<p><code>apply</code> comes in a couple of overloads:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It will apply all discovered migrations when called without arguments or with a single boolean argument i</p>
</li>
<li>
<p>It will try to resolve URLS to supported migrations and apply them as is, without writing metadata when called with
one or more URLs as argument. This method can also be ce called through the CLI (via the <code>run</code> command).</p>
</li>
<li>
<p>It will apply all refactorings in order when called with one or more instances of <code>Refactoring</code>.
This method is only available in the Core API. Please read more about it here: <a href="#applying-refactorings-programmatically">Applying refactorings programmatically</a>.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="runningonthejavamodule-path"><a class="anchor" href="#runningonthejavamodule-path"></a>4.3.2. Running on the Java module-path</h4>
<div class="paragraph">
<p>Neo4j-Migrations can be used on the Java module path. Make sure you require them in your module and export packages with Java-based migrations in case you&#8217;re using the latter.
Resources on the classpath should be picked up automatically:</p>
</div>
<div class="listingblock">
<div class="title">Listing 25. Using Neo4j-Migrations on the module path</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">module my.module {
    requires ac.simons.neo4j.migrations.core;

    exports my.module.java_based_migrations; <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Only needed when you actually have those</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_spring-boot-starter"><a class="anchor" href="#usage_spring-boot-starter"></a>4.4. Spring-Boot-Starter</h3>
<div class="paragraph">
<p>We provide a starter with automatic configuration for <a href="https://start.spring.io">Spring Boot</a>.
Declare the following dependency in your Spring Boot application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-spring-boot-starter<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or follow the instructions for Gradle in <a href="#download_springboot">download</a>.</p>
</div>
<div class="paragraph">
<p>That starter itself depends on the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java Driver</a>.
The driver is managed by Spring Boot since 2.4, and you can enjoy configuration support directly through Spring Boot.
For Spring Boot versions prior to Spring Boot 2.4, please have a look at version <a href="https://github.com/michael-simons/neo4j-migrations/tree/0.0.13">0.0.13</a> of this library.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations will automatically look for migrations in <code>classpath:neo4j/migrations</code> and will fail if this location does not exist.
It does not scan by default for Java-based migrations itself.
It will however discover all Java-based migrations that are annotated with <code>@Component</code>, <code>@Service</code> or other stereotypes and all beans that made it otherwise into the application context.
Such a Java-based migrations is free to use anything that is injectable itself, such as Spring Data Neo4j repositories.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example on how to configure the driver and the migrations:</p>
</div>
<div class="listingblock">
<div class="title">Listing 26. Configure both the driver, disable the existence check for migration scripts and scan for Java-based migration</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">spring.neo4j.authentication.username=neo4j
spring.neo4j.authentication.password=secret
spring.neo4j.uri=bolt://localhost:7687

# Add configuration for your migrations, for example, additional packages to scan
org.neo4j.migrations.packages-to-scan=your.changesets, another.changeset

# Or disable the check if the location exists
org.neo4j.migrations.check-location=false</code></pre>
</div>
</div>
<div class="paragraph">
<p>Have a look at <a href="#usage_spring-boot_all-properties">Section 4.4.2</a> for all supported properties.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The starter will log some details about the product version and the database connected to. This can be disabled by setting the logger <code>ac.simons.neo4j.migrations.core.Migrations.Startup</code> to a level higher than <code>INFO</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="usagewithdataneo4jtest"><a class="anchor" href="#usagewithdataneo4jtest"></a>4.4.1. Usage with <code>@DataNeo4jTest</code></h4>
<div class="paragraph">
<p>If you want to use your migrations together with <code>@DataNeo4jTest</code> which is provided with Spring Boot out of the box,
you have to manually import our autoconfiguration like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.springframework.boot.autoconfigure.MigrationsAutoConfiguration</span>;

<span class="keyword">import</span> <span class="include">org.junit.jupiter.api.Test</span>;
<span class="keyword">import</span> <span class="include">org.neo4j.driver.Driver</span>;

<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.boot.autoconfigure.ImportAutoConfiguration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.boot.test.autoconfigure.data.neo4j.DataNeo4jTest</span>;

<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertyRegistry</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.DynamicPropertySource</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.containers.Neo4jContainer</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Container</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.junit.jupiter.Testcontainers</span>;
<span class="keyword">import</span> <span class="include">org.testcontainers.utility.TestcontainersConfiguration</span>;

<span class="annotation">@Testcontainers</span>(disabledWithoutDocker = <span class="predefined-constant">true</span>)
<span class="annotation">@DataNeo4jTest</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="annotation">@ImportAutoConfiguration</span>(MigrationsAutoConfiguration.class) <i class="conum" data-value="2"></i><b>(2)</b>
<span class="directive">public</span> <span class="type">class</span> <span class="class">UsingDataNeo4jTest</span> {

    <span class="annotation">@Container</span>
    <span class="directive">private</span> <span class="directive">static</span> Neo4jContainer&lt;?&gt; neo4j = <span class="keyword">new</span> Neo4jContainer&lt;&gt;(<span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j:4.4</span><span class="delimiter">&quot;</span></span>)
        .withReuse(TestcontainersConfiguration.getInstance().environmentSupportsReuse()); <i class="conum" data-value="3"></i><b>(3)</b>

    <span class="annotation">@DynamicPropertySource</span>
    <span class="directive">static</span> <span class="type">void</span> neo4jProperties(DynamicPropertyRegistry registry) { <i class="conum" data-value="4"></i><b>(4)</b>

        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.neo4j.uri</span><span class="delimiter">&quot;</span></span>, neo4j::getBoltUrl);
        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.neo4j.authentication.username</span><span class="delimiter">&quot;</span></span>, () -&gt; <span class="string"><span class="delimiter">&quot;</span><span class="content">neo4j</span><span class="delimiter">&quot;</span></span>);
        registry.add(<span class="string"><span class="delimiter">&quot;</span><span class="content">spring.neo4j.authentication.password</span><span class="delimiter">&quot;</span></span>, neo4j::getAdminPassword);
    }

    <span class="annotation">@Test</span>
    <span class="type">void</span> yourTest(<span class="annotation">@Autowired</span> <span class="predefined-type">Driver</span> driver) {
        <span class="comment">// Whatever is tested</span>
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Use the dedicated Neo4j test slice</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Import <em>this</em> auto-configuration (which is not part of Spring Boot)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Bring up a container to test against</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Use <code>DynamicPropertySource</code>  for configuring the test resources dynamically</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="usage_spring-boot_all-properties"><a class="anchor" href="#usage_spring-boot_all-properties"></a>4.4.2. Available configuration properties</h4>
<div class="paragraph">
<p>The following configuration properties in the <code>org.neo4j.migrations</code> namespace are supported:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>org.neo4j.migrations.check-location</code></dt>
<dd>
<p>Whether to check that migration scripts location exists.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.Boolean</code></p>
</li>
<li>
<p>Default: <code>true</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.database</code></dt>
<dd>
<p>The database that should be migrated (Neo4j EE 4.0+ only).
Leave <code>null</code> for using the default database.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String</code></p>
</li>
<li>
<p>Default: <code>null</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.schema-database</code></dt>
<dd>
<p>The database that should be used for storing information about migrations (Neo4j EE 4.0+ only).
Leave <code>null</code> for using the default database.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String</code></p>
</li>
<li>
<p>Default: <code>null</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.impersonated-user</code></dt>
<dd>
<p>An alternative user to impersonate during migration.
Might have higher privileges than the user connected, which  will be dropped again after migration.
Requires Neo4j EE 4.4+.
Leave <code>null</code> for using the connected user.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String</code></p>
</li>
<li>
<p>Default: <code>null</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.enabled</code></dt>
<dd>
<p>Whether to enable Neo4j-Migrations or not.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.Boolean</code></p>
</li>
<li>
<p>Default: <code>true</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.encoding</code></dt>
<dd>
<p>Encoding of Cypher migrations.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.nio.charset.Charset</code></p>
</li>
<li>
<p>Default: <code>UTF-8</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.installed-by</code></dt>
<dd>
<p>Username recorded as property <code>by</code> on the <code>MIGRATED_TO</code> relationship.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String</code></p>
</li>
<li>
<p>Default: <code>System user</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.locations-to-scan</code></dt>
<dd>
<p>Locations of migrations scripts.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String[]</code></p>
</li>
<li>
<p>Default: <code>[classpath:neo4j/migrations]</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.packages-to-scan</code></dt>
<dd>
<p>List of packages to scan for Java migrations.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String[]</code></p>
</li>
<li>
<p>Default: <code>[]</code> (an empty array)</p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.transaction-mode</code></dt>
<dd>
<p>The transaction mode in use (Defaults to "per migration", meaning one script is run in one transaction).</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>TransactionMode</code></p>
</li>
<li>
<p>Default: <code>PER_MIGRATION</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.validate-on-migrate</code></dt>
<dd>
<p>Validating helps you verify that the migrations applied to the database match the ones available locally and is on by default.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.Boolean</code></p>
</li>
<li>
<p>Default: <code>true</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.autocrlf</code></dt>
<dd>
<p>Automatically convert Windows line-endings (CRLF) to LF when reading resource based migrations, pretty much what the same Git option does during checkin.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.Boolean</code></p>
</li>
<li>
<p>Default: <code>false</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.delay-between-migrations</code></dt>
<dd>
<p>A configurable delay that will be applied in between applying two migrations.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.time.Duration</code></p>
</li>
<li>
<p>Default: <code>false</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.version-sort-order</code></dt>
<dd>
<p>How versions should be sorted. The default of <code>LEXICOGRAPHIC</code> will change to <code>SEMANTIC</code> in a future version of this library.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>ac.simons.neo4j.migrations.core.MigrationsConfig#VersionSortOrder</code></p>
</li>
<li>
<p>Default: <code>LEXICOGRAPHIC</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.out-of-order</code></dt>
<dd>
<p>A flag to enable out-of-order migrations.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.Boolean</code></p>
</li>
<li>
<p>Default: <code>false</code></p>
</li>
</ul>
</div>
</dd>
<dt class="hdlist1"><code>org.neo4j.migrations.target</code></dt>
<dd>
<p>Configures the target version up to which migrations should be considered. This must be a valid migration version, or one of the special values <code>current</code>, <code>latest</code> or <code>next</code>.</p>
<div class="ulist">
<ul>
<li>
<p>Type: <code>java.lang.String</code></p>
</li>
<li>
<p>Default: <code>null</code></p>
</li>
</ul>
</div>
</dd>
</dl>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Migrations can be disabled by setting <code>org.neo4j.migrations.enabled</code> to <code>false</code>.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_quarkus"><a class="anchor" href="#usage_quarkus"></a>4.5. Quarkus</h3>
<div class="paragraph">
<p>We provide an extension with automatic configuration for Quarkus.
Declare the following dependency in your Quarkus application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-quarkus<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That extension itself depends on the <a href="https://github.com/neo4j/neo4j-java-driver">Neo4j Java Driver</a> and the corresponding
Quarkus extension <a href="https://github.com/quarkiverse/quarkus-neo4j">Quarkus-Neo4j</a> and requires at least Quarkus 2.6.
You don&#8217;t need to declare those dependencies, they are already transitive dependencies of this extension.</p>
</div>
<div class="paragraph">
<p>Neo4j-Migrations will automatically look for migrations in <code>classpath:neo4j/migrations</code> and will fail if this location does not exist.
It does not scan by default for Java-based migrations.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s an example on how to configure the driver and the migrations:</p>
</div>
<div class="listingblock">
<div class="title">Listing 27. Configure both the driver and scan for Java-based migrations, too</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="properties">quarkus.neo4j.uri=bolt://localhost:7687
quarkus.neo4j.authentication.username=neo4j
quarkus.neo4j.authentication.password=secret

org.neo4j.migrations.packages-to-scan=foo.bar</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you disable Neo4j-Migrations via <code>org.neo4j.migrations.enabled</code> we won&#8217;t apply Migrations at startup but the <code>Migrations</code> object
will still be in the context to be used.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
All other properties available for the <a href="#usage_spring-boot_all-properties">Spring-Boot-Starter</a> are available for the Quarkus extension, too.
Their namespace is the same: <code>org.neo4j.migrations</code>.
The module will also log some details about the product version and the database connected to. This can be disabled by setting the logger <code>ac.simons.neo4j.migrations.core.Migrations.Startup</code> to a level higher than <code>INFO</code>.
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="build-timevsruntimeconfig"><a class="anchor" href="#build-timevsruntimeconfig"></a>4.5.1. Build-time vs runtime config</h4>
<div class="paragraph">
<p><code>org.neo4j.migrations.packages-to-scan</code> and <code>org.neo4j.migrations.locations-to-scan</code> are build-time configuration options
and cannot be changed during runtime. This allows for optimized images to be created: All migrations that are part of the
classpath (both scripts and class based migrations) are discovered during  image build-time already and are included in
the image themselves (this applies to both native and JVM images).</p>
</div>
<div class="paragraph">
<p>While scripts in file system locations (all locations starting with <code>file://</code>) are still discovered during runtime and thus
allows for scripts being added without recreating the application image, the location cannot be dynamically changed. If you
need a dynamic, <code>file://</code> based location, use <code>org.neo4j.migrations.external-locations</code>. This property is changeable during
runtime and allows for one image being used in different deployments pointing to different external locations with scripts
outside the classpath</p>
</div>
<div class="paragraph">
<p>An alternative approach to that is using the CLI in a sidecar container, pointing to the dynamic location and keep applying
database migrations outside the application itself.</p>
</div>
</div>
<div class="sect3">
<h4 id="devservicesintegration"><a class="anchor" href="#devservicesintegration"></a>4.5.2. Dev Services integration</h4>
<div class="paragraph">
<p>Neo4j-Migrations will appear as a tile in the Quarkus Dev UI under <a href="http://localhost:8080/q/dev/" class="bare">http://localhost:8080/q/dev/</a>.
It provides a <a href="http://localhost:8080/q/dev/eu.michael-simons.neo4j.neo4j-migrations-quarkus/migrations">list of migrations</a>
which can be used to clean the database or apply all migrations.
The latter is handy when migrate at start is disabled or in case there are callbacks that might reset or recreate testdata.</p>
</div>
<div class="videoblock">
<div class="content">
<video controls style="width: 100%;">
  <source src="img/quarkus-dev-ui.webm" type="video/webm">
</video>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_maven-plugin"><a class="anchor" href="#usage_maven-plugin"></a>4.6. Maven-Plugin</h3>
<div class="paragraph">
<p>You can trigger Neo4j-Migrations from your build a Maven-Plugin.
Please refer to the dedicated <a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/plugin-info.html">Maven-Plugin page</a> for
a detailed list of all goals and configuration option as well as the default lifecycle mapping of the plugin.</p>
</div>
<div class="sect3">
<h4 id="configuration"><a class="anchor" href="#configuration"></a>4.6.1. Configuration</h4>
<div class="paragraph">
<p>Most of the time you will configure the following properties for the plugin:</p>
</div>
<div class="listingblock">
<div class="title">Listing 28. Configuring the Maven-Plugin</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-maven-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;configuration&gt;</span>
                <span class="tag">&lt;user&gt;</span>neo4j<span class="tag">&lt;/user&gt;</span>
                <span class="tag">&lt;password&gt;</span>secret<span class="tag">&lt;/password&gt;</span>
                <span class="tag">&lt;address&gt;</span>bolt://localhost:${it-database-port}<span class="tag">&lt;/address&gt;</span>
                <span class="tag">&lt;verbose&gt;</span>true<span class="tag">&lt;/verbose&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>All goals provide those properties.
By default, the plugin will look in <code>neo4j/migrations</code> for <a href="#concepts_migrations_cypher-based">Cypher-based migrations</a>.
You can change that via <code>locationsToScan</code> inside the <code>configuration</code> element like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 29. Changing the locations to scan for the Maven-Plugin</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;locationsToScan&gt;</span>
    <span class="tag">&lt;locationToScan&gt;</span>file://${project.build.outputDirectory}/custom/path<span class="tag">&lt;/locationToScan&gt;</span>
<span class="tag">&lt;/locationsToScan&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Add multiple <code>locationToScan</code> elements for multiple locations to scan.</p>
</div>
</div>
<div class="sect3">
<h4 id="goals"><a class="anchor" href="#goals"></a>4.6.2. Goals</h4>
<div class="paragraph">
<p>All goals as described in <a href="#usage_common">Section 4.1</a> are supported.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/clean-mojo.html">clean</a>, see <a href="#usage_common_clean">Section 4.1.1</a></p>
</li>
<li>
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/help-mojo.html">help</a></p>
</li>
<li>
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/info-mojo.html">info</a>, see <a href="#usage_common_info">Section 4.1.3</a></p>
</li>
<li>
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/migrate-mojo.html">migrate</a>, see <a href="#usage_common_migrate">Section 4.1.4</a></p>
</li>
<li>
<p><a href="https://michael-simons.github.io/neo4j-migrations/main/site/neo4j-migrations-maven-plugin/validate-mojo.html">clean</a>, see <a href="#usage_common_validate">Section 4.1.6</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The above list links to the corresponding Maven-Plugin page, please check those goals out for further details.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="usage_defining_asserting_applying_catalogs"><a class="anchor" href="#usage_defining_asserting_applying_catalogs"></a>4.7. Defining and using catalogs</h3>
<div class="paragraph">
<p>This chapter is more about conceptional usage or scenarios one can implement by using <a href="#concepts_migrations_catalog-based">Catalog-based migrations</a>.
All scenarios can be executed with any of the previously explained APIS, being it the CLI, the Core API or within  Spring Boot,
Quarkus or Maven, except easily dumping a local or a remote catalog as XML or Cypher file.</p>
</div>
<div class="paragraph">
<p>Catalogs are a powerful mechanism to shape your database&#8217;s schema exactly the way you want it and this is only a small subset of
possible scenarios that can be implemented.</p>
</div>
<div class="paragraph">
<p>For the rest of these steps we assume that you are using the CLI and used the <code>init</code> command to create a local directory structure
holding connection data such as URL and credentials as well as your migrations:</p>
</div>
<div class="listingblock">
<div class="title">Listing 30. Create migrations directory with credentials etc.</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations -a bolt://localhost:7687 -u neo4j -p secret init
tree -a</code></pre>
</div>
</div>
<div class="paragraph">
<p>which will result in</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">.
 .migrations.properties
 neo4j
     migrations

2 directories, 1 file</code></pre>
</div>
</div>
<div class="paragraph">
<p>All migrations we are going to work with will be stored in <code>neo4j/migrations</code>.</p>
</div>
<div class="paragraph">
<p>One sensible step before doing anything with the schema is to assert our local catalog meets the remote catalog as expected.
In this example we assert toe remote catalog to be empty and we define our first migration like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 31. V010__Assert_empty_schema.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;verify</span> <span class="attribute-name">useCurrent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>useCurrent</code> has been set to <code>true</code> to refer to the local catalog as defined in version 10, which is been empty,
exactly what we expect</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Applying this now via <code>neo4j-migrations apply</code> yields the following result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2022-06-01T15:13:39.997000000] Applied migration 010 (&quot;Assert empty schema&quot;).
Database migrated to version 010.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Of course this step is only executed once, when this migration is applied. If we add another one too it, that
verification does not happen again, as the 010 has been applied. Therefore, a verification step can be added to
each catalog based migration:</p>
</div>
<div class="listingblock">
<div class="title">Listing 32. V020__Create_person_name_unique.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;catalog&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>name<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>

  <span class="tag">&lt;verify</span><span class="tag">/&gt;</span>
  <span class="tag">&lt;create</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that we didn&#8217;t specify <code>useCurrent</code> here. This means verification should happen based on the local catalog prior to
version 020. Applying this migration yields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2022-06-01T15:17:27.508000000] Skipping already applied migration 010 (&quot;Assert empty schema&quot;)
[2022-06-01T15:17:27.771000000] Applied migration 020 (&quot;Create person name unique&quot;).
Database migrated to version 020.</code></pre>
</div>
</div>
<div class="paragraph">
<p>A day later you figure out that a unique constraint on a persons names isn&#8217;t the best of all ideas, and you decide to
fix that. Assuming for sake of sanity that every person has a name, we replace that uniqueness with an existential constraint.</p>
</div>
<div class="paragraph">
<p>Existential constraints are a Neo4j enterprise feature, so we must cater for that as well and we define two different files
for the next version:</p>
</div>
<div id="V030Fix_person_name_constraint_CE" class="listingblock">
<div class="title">Listing 33. V030__Fix_person_name_constraint_CE.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;?assume that edition is community ?&gt;</span>
  <span class="tag">&lt;drop</span> <span class="attribute-name">item</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>and for the enterprise edition, we can redefine the constraint like this:</p>
</div>
<div id="V030Fix_person_name_constraint_EE" class="listingblock">
<div class="title">Listing 34. V030__Fix_person_name_constraint_EE.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;?assume that edition is enterprise ?&gt;</span>
  <span class="tag">&lt;catalog&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exists</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>name<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>

  <span class="tag">&lt;drop</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;create</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note how we <strong>can</strong> <code>refer</code> to the constraint by ref in <a href="#V030Fix_person_name_constraint_EE">Listing 34</a> and how we <strong>must</strong> use
<code>item</code> in <a href="#V030Fix_person_name_constraint_CE">Listing 33</a>. The reason for that is that we refer to an older item only in the
migration for community edition. We redefined the item in the script for the enterprise edition, so we might as well
refer to it.
In older Neo4j versions not supporting names for constraints Neo4j-Migrations will use the old definition to drop the item
in question.</p>
</div>
<div class="paragraph">
<p>Applying the current state now yields</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2022-06-01T16:04:46.446188000] Skipping 030 (&quot;Fix person name constraint CE&quot;) due to unmet preconditions:
// assume that edition is COMMUNITY
[2022-06-01T16:04:46.493400000] Skipping already applied migration 010 (&quot;Assert empty schema&quot;)
[2022-06-01T16:04:46.496401000] Skipping already applied migration 020 (&quot;Create person name unique&quot;)
[2022-06-01T16:04:46.659585000] Applied migration 030 (&quot;Fix person name constraint EE&quot;).
Database migrated to version 030.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assuming you some other enterprise stuff related items in the following listing:</p>
</div>
<div id="V040Additional_stuff" class="listingblock">
<div class="title">Listing 35. V040__Additional_stuff.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="comment">&lt;?assume that edition is enterprise ?&gt;</span>
  <span class="tag">&lt;catalog&gt;</span>
    <span class="tag">&lt;indexes</span><span class="tag">/&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">liked_day</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exists</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;type&gt;</span>LIKED<span class="tag">&lt;/type&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>day<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_keys</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>firstname<span class="tag">&lt;/property&gt;</span>
          <span class="tag">&lt;property&gt;</span>surname<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>

  <span class="tag">&lt;create</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">liked_day</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;create</span> <span class="attribute-name">ref</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_keys</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To get some information about your database, you can inspect the remote catalog:</p>
</div>
<div class="listingblock">
<div class="title">Listing 36. Inspecting the remote catalog</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations show-catalog</code></pre>
</div>
</div>
<div class="paragraph">
<p>and it will print the catalog in XML:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;no&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;catalog&gt;</span>
        <span class="tag">&lt;indexes</span><span class="tag">/&gt;</span>
        <span class="tag">&lt;constraints&gt;</span>
            <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">liked_day</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;label&gt;</span>LIKED<span class="tag">&lt;/label&gt;</span>
                <span class="tag">&lt;properties&gt;</span>
                    <span class="tag">&lt;property&gt;</span>day<span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;/properties&gt;</span>
            <span class="tag">&lt;/constraint&gt;</span>
            <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_keys</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
                <span class="tag">&lt;properties&gt;</span>
                    <span class="tag">&lt;property&gt;</span>firstname<span class="tag">&lt;/property&gt;</span>
                    <span class="tag">&lt;property&gt;</span>surname<span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;/properties&gt;</span>
            <span class="tag">&lt;/constraint&gt;</span>
            <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">person_name_unique</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exists</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
                <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
                <span class="tag">&lt;properties&gt;</span>
                    <span class="tag">&lt;property&gt;</span>name<span class="tag">&lt;/property&gt;</span>
                <span class="tag">&lt;/properties&gt;</span>
            <span class="tag">&lt;/constraint&gt;</span>
        <span class="tag">&lt;/constraints&gt;</span>
    <span class="tag">&lt;/catalog&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also get the catalog as Cypher with</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations show-catalog format=CYPHER version=4.4</code></pre>
</div>
</div>
<div class="paragraph">
<p>yielding</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE CONSTRAINT person_keys IF NOT EXISTS FOR (n:Person) REQUIRE (n.firstname, n.surname) IS NODE KEY;
CREATE CONSTRAINT liked_day IF NOT EXISTS FOR ()-[r:LIKED]-() REQUIRE r.day IS NOT NULL;
CREATE CONSTRAINT person_name_unique IF NOT EXISTS FOR (n:Person) REQUIRE n.name IS NOT NULL;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changing the version number to an older version will give the correct syntax, too:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">&gt; neo4j-migrations show-catalog format=CYPHER version=3.5
CREATE CONSTRAINT ON (n:Person) ASSERT (n.firstname, n.surname) IS NODE KEY;
CREATE CONSTRAINT ON ()-[r:LIKED]-() ASSERT exists(r.day);
CREATE CONSTRAINT ON (n:Person) ASSERT exists(n.name);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After all, you decide it&#8217;s best not to stick with any constraint on the persons name and also drop your experiments.
You could use <code>&lt;apply /&gt;</code> to make your database look exactly like your catalog. But that would include all previously
defined items, too.</p>
</div>
<div class="paragraph">
<p>Therefore, you need to reset the catalog as shown in the following listing:</p>
</div>
<div id="V050A_new_start" class="listingblock">
<div class="title">Listing 37. V050__A_new_start.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;catalog</span> <span class="attribute-name">reset</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_person_id</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Person<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>id<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>
  <span class="tag">&lt;apply</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>followed by a final verification:</p>
</div>
<div id="V060Assert_final_state" class="listingblock">
<div class="title">Listing 38. V060__Assert_final_state.xml</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;verify</span> <span class="attribute-name">allowEquivalent</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the following commands to see the outcome:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations apply</code></pre>
</div>
</div>
<div class="paragraph">
<p>applies everything:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">[2022-06-01T19:16:20.058218000] Skipping 030 (&quot;Fix person name constraint CE&quot;) due to unmet preconditions:
// assume that edition is COMMUNITY
[2022-06-01T19:16:20.223937000] Skipping already applied migration 010 (&quot;Assert empty schema&quot;)
[2022-06-01T19:16:20.225464000] Skipping already applied migration 020 (&quot;Create person name unique&quot;)
[2022-06-01T19:16:20.225748000] Skipping already applied migration 030 (&quot;Fix person name constraint EE&quot;)
[2022-06-01T19:16:20.226022000] Skipping already applied migration 040 (&quot;Additional stuff&quot;)
[2022-06-01T19:16:20.501686000] Applied migration 050 (&quot;A new start&quot;).
[2022-06-01T19:16:20.551983000] Applied migration 060 (&quot;Assert final state&quot;).
Database migrated to version 060.</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations show-catalog format=CYPHER</code></pre>
</div>
</div>
<div class="paragraph">
<p>presents the remote catalog as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE CONSTRAINT unique_person_id IF NOT EXISTS FOR (n:Person) REQUIRE n.id IS UNIQUE;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and so does the local catalog</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">neo4j-migrations show-catalog format=CYPHER mode=LOCAL 2&amp;&gt;/dev/null</code></pre>
</div>
</div>
<div class="paragraph">
<p>The redirect is included here so that log messages on stderr are skipped (the message about one migration skipped due to unmet preconditions).</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="anchor" href="#appendix"></a>Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="glossary"><a class="anchor" href="#glossary"></a>Glossary</h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Pending migration</dt>
<dd>
<p>See <em>Resolved migration</em>.</p>
</dd>
<dt class="hdlist1">Resolved migration</dt>
<dd>
<p>A migration that has been resolved in the classpath or the filesystem which has not been yet applied.</p>
</dd>
<dt class="hdlist1">Schema database</dt>
<dd>
<p>A database inside a Neo4j enterprise instance or cluster that stores the schema information from Neo4j-Migrations.</p>
</dd>
<dt class="hdlist1">Target database</dt>
<dd>
<p>A database inside a Neo4j enterprise instance or cluster that is refactored by Neo4j-Migrations.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="appendix_xml_schemes"><a class="anchor" href="#appendix_xml_schemes"></a>XML Schemes</h3>
<div class="sect3">
<h4 id="appendix_xml_schemes_migration"><a class="anchor" href="#appendix_xml_schemes_migration"></a><code>migration.xsd</code></h4>
<div class="paragraph">
<p>Before we jump into the pure joy of an <a href="https://en.wikipedia.org/wiki/XML_Schema_(W3C)">XML Schema</a>, lets read in plain english
what our schema can do:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>&lt;migration /&gt;</code> can have zero or exactly one <code>&lt;catalog /&gt;</code> element.</p>
</li>
<li>
<p>A <code>&lt;catalog /&gt;</code> consists of zero or one <code>&lt;constraints /&gt;</code> and zero or one <code>&lt;indexes /&gt;</code> elements. In addition, it can indicate
a <code>reset</code> attribute, replacing the current known content with the catalog currently being in definition.</p>
</li>
<li>
<p>Both of them can contain zero or more of their individual elements, according to their definition.</p>
</li>
<li>
<p>A <code>&lt;migration /&gt;</code> can have zero or one <code>&lt;verify /&gt;</code> operations and the <code>&lt;verify /&gt;</code> operation must be the first operation.</p>
</li>
<li>
<p>A <code>&lt;migration /&gt;</code> can than have zero or more <code>&lt;create /&gt;</code> and <code>&lt;drop /&gt;</code> operations <strong>or</strong> exactly one <code>&lt;apply /&gt;</code> operation.
The <code>&lt;apply /&gt;</code> operation is mutual exclusive to all operations working on single items.</p>
</li>
<li>
<p>Operations that work on a single item (create and drop) are allowed to define a single item locally. This item
won&#8217;t participate in the global catalog.</p>
</li>
<li>
<p>Operations that work on a single item can refer to this item by either using the attribute <code>item</code> (a free form string)
or <code>ref</code> (an <code>xs:IDREF</code>). While the latter is useful for referring to items defined in the same migration (it will usually
be validated by your tooling), the former is handy to refer to items defined in other migrations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A catalog item will either have a child-element <code>&lt;label /&gt;</code> in which case it will always refer to nodes or a mutual
exclusive child-element <code>&lt;type /&gt;</code> in which it always refers to relationships. The <code>type</code> attribute is unrelated
to the target entity. This attribute defines the type of the element (such as unique- or existential constraints).</p>
</div>
<div class="paragraph">
<p>We do support the following processing instructions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>&lt;?assert followed by a valid precondition ?&gt;</code></p>
</li>
<li>
<p><code>&lt;?assume followed by a valid precondition ?&gt;</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Look up valid preconditions <a href="#concepts_preconditions">here</a>. The full XMl schema for <a href="#concepts_migrations_catalog-based">catalog-based migrations</a> looks like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 39. migration.xsd</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="comment">&lt;!--

    Copyright 2020-2025 the original author or authors.

    Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

         https://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

--&gt;</span>
<span class="tag">&lt;xs:schema</span> <span class="attribute-name">xmlns:xs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">targetNamespace</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span>
       <span class="attribute-name">elementFormDefault</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">qualified</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migration</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migration</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migration</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:sequence&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">verify</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">verifyOperation</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
      <span class="tag">&lt;xs:choice&gt;</span>
        <span class="tag">&lt;xs:choice</span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refactor</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refactoring</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:choice</span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">create</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createOperation</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">drop</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropOperation</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:choice&gt;</span>
        <span class="tag">&lt;/xs:choice&gt;</span>
        <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">apply</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applyOperation</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/xs:choice&gt;</span>
    <span class="tag">&lt;/xs:sequence&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">refactoring</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:sequence</span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">parameters</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:complexType&gt;</span>
          <span class="tag">&lt;xs:sequence</span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;xs:any</span> <span class="attribute-name">processContents</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lax</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;/xs:complexType&gt;</span>
      <span class="tag">&lt;/xs:element&gt;</span>
    <span class="tag">&lt;/xs:sequence&gt;</span>
    <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;xs:simpleType&gt;</span>
        <span class="tag">&lt;xs:restriction</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">merge.nodes</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrate.createFutureIndexes</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrate.replaceBTreeIndexes</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">normalize.asBoolean</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.label</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.type</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.nodeProperty</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.relationshipProperty</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addSurrogateKeyTo.nodes</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addSurrogateKeyTo.relationships</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:restriction&gt;</span>
      <span class="tag">&lt;/xs:simpleType&gt;</span>
    <span class="tag">&lt;/xs:attribute&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalog</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:all&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraints</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:complexType&gt;</span>
          <span class="tag">&lt;xs:sequence&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;/xs:complexType&gt;</span>
      <span class="tag">&lt;/xs:element&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">indexes</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:complexType&gt;</span>
          <span class="tag">&lt;xs:sequence&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;/xs:complexType&gt;</span>
      <span class="tag">&lt;/xs:element&gt;</span>
    <span class="tag">&lt;/xs:all&gt;</span>
    <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">reset</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">operation</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">applyOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">operation</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">verifyOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">operation</span><span class="delimiter">&quot;</span></span> <span class="tag">&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">useCurrent</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">allowEquivalent</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">includeOptions</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">false</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">operation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:sequence&gt;</span>
          <span class="tag">&lt;xs:choice</span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:choice&gt;</span>
        <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">item</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ref</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:IDREF</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">createOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ifNotExists</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">dropOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">itemOperation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ifExists</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:boolean</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">default</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:simpleContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;xs:simpleType&gt;</span>
            <span class="tag">&lt;xs:restriction</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">BOOLEAN</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">STRING</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">INTEGER</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">FLOAT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DATE</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL TIME</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ZONED TIME</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">LOCAL DATETIME</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ZONED DATETIME</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">DURATION</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">POINT</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/xs:restriction&gt;</span>
          <span class="tag">&lt;/xs:simpleType&gt;</span>
        <span class="tag">&lt;/xs:attribute&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:simpleContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:sequence&gt;</span>
      <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">maxOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unbounded</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/xs:sequence&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalogItem</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">use</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:ID</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">constraint</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalogItem</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:sequence&gt;</span>
          <span class="tag">&lt;xs:choice&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:choice&gt;</span>
          <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">options</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">use</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">required</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;xs:simpleType&gt;</span>
            <span class="tag">&lt;xs:restriction</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">exists</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">key</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property_type</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/xs:restriction&gt;</span>
          <span class="tag">&lt;/xs:simpleType&gt;</span>
        <span class="tag">&lt;/xs:attribute&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>

  <span class="tag">&lt;xs:complexType</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">index</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;xs:complexContent&gt;</span>
      <span class="tag">&lt;xs:extension</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">catalogItem</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;xs:sequence&gt;</span>
          <span class="tag">&lt;xs:choice&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">label</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;xs:element</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;/xs:choice&gt;</span>
          <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">properties</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
          <span class="tag">&lt;xs:element</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">options</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">minOccurs</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">0</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;/xs:sequence&gt;</span>
        <span class="tag">&lt;xs:attribute</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;xs:simpleType&gt;</span>
            <span class="tag">&lt;xs:restriction</span> <span class="attribute-name">base</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">xs:string</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">fulltext</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
              <span class="tag">&lt;xs:enumeration</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/xs:restriction&gt;</span>
          <span class="tag">&lt;/xs:simpleType&gt;</span>
        <span class="tag">&lt;/xs:attribute&gt;</span>
      <span class="tag">&lt;/xs:extension&gt;</span>
    <span class="tag">&lt;/xs:complexContent&gt;</span>
  <span class="tag">&lt;/xs:complexType&gt;</span>
<span class="tag">&lt;/xs:schema&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendix_refactorings"><a class="anchor" href="#appendix_refactorings"></a>Refactorings</h3>
<div class="paragraph">
<p>Neo4j-Migrations contains a set of ready-to-use database refactorings. These refactorings are all modelled very closely to those available in <a href="https://neo4j.com/labs/apoc/4.4/overview/apoc.refactor/">APOC</a> but <strong>none</strong> of them requires APOC to be installed in your database. The refactorings are mostly designed to work from within a <a href="#concepts_catalog">catalog</a> but they work very well on their own to. While they are part of the <a href="#usage_core">Core API</a>, they don&#8217;t depend on a Migration instance. Their API is subject to the same versioning guarantees as the rest of Neo4j-Migrations. Refactorings might evolve into a their module at a later point in time.</p>
</div>
<div class="paragraph">
<p>Some refactorings require certain Neo4j versions. If you do support multiple Neo4j versions, define those refactorings as single itemed migrations and add assumptions like in the following example:</p>
</div>
<div class="listingblock">
<div class="title">Listing 40. Normalize boolean properties when running Neo4j 4.1+</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>

  <span class="comment">&lt;?assume that version is ge 4.1 ?&gt;</span>

  <span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">normalize.asBoolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;parameters&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>watched<span class="tag">&lt;/parameter&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trueValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>y<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>YES<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/parameter&gt;</span>
      <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">falseValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;value&gt;</span>n<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;value&gt;</span>NO<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;/parameters&gt;</span>
  <span class="tag">&lt;/refactor&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="sect3">
<h4 id="applying-refactorings-programmatically"><a class="anchor" href="#applying-refactorings-programmatically"></a>Applying refactorings programmatically</h4>
<div class="paragraph">
<p>While you would normally use the declarative approach of applying refactorings from within XML / catalog based migrations, Neo4j-Migrations offers an API for it as well:</p>
</div>
<div class="listingblock">
<div class="title">Listing 41. Rename one type and normalize attributes to boolean in a programmatic fashion</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (Session session = driver.session()) {
  session.run(<span class="string"><span class="delimiter">&quot;</span><span class="content">CREATE (m:Person {name:'Michael'}) -[:LIKES]-&gt; (n:Person {name:'Tina', klug:'ja'})</span><span class="delimiter">&quot;</span></span>); <i class="conum" data-value="1"></i><b>(1)</b>
}

Migrations migrations = <span class="keyword">new</span> Migrations(MigrationsConfig.defaultConfig(), driver); <i class="conum" data-value="2"></i><b>(2)</b>

Counters counters = migrations.apply(
  Rename.type(<span class="string"><span class="delimiter">&quot;</span><span class="content">LIKES</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">MAG</span><span class="delimiter">&quot;</span></span>), <i class="conum" data-value="3"></i><b>(3)</b>
  Normalize.asBoolean(<span class="string"><span class="delimiter">&quot;</span><span class="content">klug</span><span class="delimiter">&quot;</span></span>, <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">ja</span><span class="delimiter">&quot;</span></span>), <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">nein</span><span class="delimiter">&quot;</span></span>))
);

<span class="keyword">try</span> (Session session = driver.session()) {
  <span class="type">long</span> cnt = session
    .run(<span class="string"><span class="delimiter">&quot;</span><span class="content">MATCH (m:Person {name:'Michael'}) -[:MAG]-&gt; (n:Person {name:'Tina', klug: true}) RETURN count(m)</span><span class="delimiter">&quot;</span></span>)
    .single().get(<span class="integer">0</span>).asLong();
  <span class="keyword">assert</span> cnt == <span class="integer">1</span>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The graph that will be refactored</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>You can create the instance as shown here or use the existing one when you already use the Spring Boot starter or the Quarkus extensions</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Build as many refactorings as needed, they will be applied in order. You can use the counters to check for the numbers of modifications</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="mergingnodes"><a class="anchor" href="#mergingnodes"></a>Merging nodes</h4>
<div class="paragraph">
<p><code>Merge.nodes(String source, List&lt;PropertyMergePolicy&gt; mergePolicies)</code> merges all the nodes, their properties and relationships onto a single node (the first in the list of matched nodes). It is important that your query uses an ordered return for this to work proper.</p>
</div>
<div class="paragraph">
<p>The <code>Merge</code> refactoring requires Neo4j 4.4+.</p>
</div>
<div class="paragraph">
<p>As catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">merge.nodes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">sourceQuery</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>MATCH (p:Person) RETURN p ORDER BY p.name ASC<span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Repeat as often as necessary --&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;pattern&gt;</span>name<span class="tag">&lt;/pattern&gt;</span>
      <span class="tag">&lt;strategy&gt;</span>KEEP_LAST<span class="tag">&lt;/strategy&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">mergePolicy</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;pattern&gt;</span>.*<span class="tag">&lt;/pattern&gt;</span>
      <span class="tag">&lt;strategy&gt;</span>KEEP_FIRST<span class="tag">&lt;/strategy&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="normalizing"><a class="anchor" href="#normalizing"></a>Normalizing</h4>
<div class="paragraph">
<p>Normalizing is the process to take an humongous set of properties and other Graph Items and apply a scheme to it.
The normalizing refactoring requires at least Neo4j 4.1, running it with batches requires Neo4j 4.4 or higher.</p>
</div>
<div class="sect4">
<h5 id="normalizepropertiesasboolean"><a class="anchor" href="#normalizepropertiesasboolean"></a>Normalize properties as boolean</h5>
<div class="paragraph">
<p>Often times database schemes evolved over time, and you find properties with a boolean meaning and a string datatype with content such as <code>ja</code>, <code>HiddenB</code>, <code>yes</code>, <code>NO</code> or literal null. To use them proper in queries, you might want to normalize them into a real boolean value. This is done with <code>Normalize.asBoolean</code>.</p>
</div>
<div class="paragraph">
<p><code>Normalize.asBoolean</code> takes in the name of a property and a list of values that are treated as <code>true</code> and a list of values that are treated as <code>false</code>. A property with a value that is not in any of those lists will be deleted. <code>null</code> as value is a non-existent property. However, if either lists contains literal <code>null</code>, a property will be created with the corresponding value.</p>
</div>
<div class="paragraph">
<p>By default all properties of all nodes and relationships will be normalized. To only apply this refactoring to a subset, i.e. only to nodes, you would want to use a custom query.</p>
</div>
<div class="paragraph">
<p>A Java example looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Normalize.asBoolean(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">watched</span><span class="delimiter">&quot;</span></span>,
    <span class="predefined-type">List</span>.of(<span class="string"><span class="delimiter">&quot;</span><span class="content">y</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">YES</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">JA</span><span class="delimiter">&quot;</span></span>),
        <span class="comment">// List.of does not support literal null,</span>
        <span class="comment">// so we need to this the old-school</span>
    <span class="predefined-type">Arrays</span>.asList(<span class="string"><span class="delimiter">&quot;</span><span class="content">n</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">NO</span><span class="delimiter">&quot;</span></span>, <span class="predefined-constant">null</span>)
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The same as a catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">normalize.asBoolean</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>watched<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">trueValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;value&gt;</span>y<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;value&gt;</span>YES<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;value&gt;</span>JA<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">falseValues</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;value&gt;</span>n<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;value&gt;</span>NO<span class="tag">&lt;/value&gt;</span>
      <span class="tag">&lt;value</span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Optional custom query and batch size --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;customQuery&quot;&gt;MATCH (n:Movie) return n&lt;/parameter&gt;
    &lt;parameter name=&quot;batchSize&quot;&gt;42&lt;/parameter&gt;
    --&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="renaminglabelstypesandproperties"><a class="anchor" href="#renaminglabelstypesandproperties"></a>Renaming labels, types and properties</h4>
<div class="paragraph">
<p><code>ac.simons.neo4j.migrations.core.refactorings.Rename</code> renames labels, types and properties and requires in its default form only Neo4j 3.5 to work. Custom queries for filtering target entities require Neo4j 4.1, batches Neo4j 4.4.</p>
</div>
<div class="sect4">
<h5 id="commonmethods"><a class="anchor" href="#commonmethods"></a>Common methods</h5>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>inBatchesOf</code></dt>
<dd>
<p>Enables or disables batching, requires Neo4j 4.4</p>
</dd>
<dt class="hdlist1"><code>withCustomQuery</code></dt>
<dd>
<p>Provides a custom query matching an entity (Node or Label) for renaming. The query must return zero or more rows each containing one item. This feature requires Neo4j 4.1</p>
</dd>
</dl>
</div>
</div>
<div class="sect4">
<h5 id="renaminglabels"><a class="anchor" href="#renaminglabels"></a>Renaming labels</h5>
<div class="paragraph">
<p><code>Rename.label(String from, String to)</code> renames all labels on all nodes that are equal the value of <code>from</code> to the value of <code>to</code>.</p>
</div>
<div class="paragraph">
<p>As catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.label</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>Engineer<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>DevRel<span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Optional custom query --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;customQuery&quot;&gt;&lt;![CDATA[
      MATCH (person:Engineer)
      WHERE person.name IN [&quot;Mark&quot;, &quot;Jennifer&quot;, &quot;Michael&quot;]
      RETURN person
    ]]&gt;&lt;/parameter&gt;
    --&gt;</span>
    <span class="comment">&lt;!-- Optional batch size (requires Neo4j 4.4+) --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;batchSize&quot;&gt;23&lt;/parameter&gt;
    --&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="renamingtypes"><a class="anchor" href="#renamingtypes"></a>Renaming types</h5>
<div class="paragraph">
<p><code>Rename.type(String from, String to)</code> renames all types on all relationships that are equal the value of <code>from</code> to the value of <code>to</code>.</p>
</div>
<div class="paragraph">
<p>As catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>COLLEAGUES<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>FROLLEAGUES<span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Optional custom query --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;customQuery&quot;&gt;&lt;![CDATA[
      MATCH (:Engineer {name: &quot;Jim&quot;})-[rel]-&gt;(:Engineer {name: &quot;Alistair&quot;})
      RETURN rel
    ]]&gt;&lt;/parameter&gt;
    --&gt;</span>
    <span class="comment">&lt;!-- Optional batch size (requires Neo4j 4.4+) --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;batchSize&quot;&gt;23&lt;/parameter&gt;
    --&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="renamingnodeproperties"><a class="anchor" href="#renamingnodeproperties"></a>Renaming node properties</h5>
<div class="paragraph">
<p><code>Rename.nodeProperty(String from, String to)</code> renames all properties on all nodes that are equal the value of <code>from</code> to the value of <code>to</code>.</p>
</div>
<div class="paragraph">
<p>As catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.nodeProperty</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>released<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>verffentlicht im Jahr<span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Optional custom query --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;customQuery&quot;&gt;&lt;![CDATA[
      MATCH (n:Movie) WHERE n.title =~ '.*Matrix.*' RETURN n
    ]]&gt;&lt;/parameter&gt;
    --&gt;</span>
    <span class="comment">&lt;!-- Optional batch size (requires Neo4j 4.4+) --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;batchSize&quot;&gt;23&lt;/parameter&gt;
    --&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="renamingtypeproperties"><a class="anchor" href="#renamingtypeproperties"></a>Renaming type properties</h5>
<div class="paragraph">
<p><code>Rename.typeProperty(String from, String to)</code> renames all properties on all relationships that are equal the value of <code>from</code> to the value of <code>to</code>.</p>
</div>
<div class="paragraph">
<p>As catalog item:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">rename.relationshipProperty</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">from</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>roles<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">to</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>rollen<span class="tag">&lt;/parameter&gt;</span>
    <span class="comment">&lt;!-- Optional custom query --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;customQuery&quot;&gt;&lt;![CDATA[
      MATCH (n:Movie) &lt;-[r:ACTED_IN] -() WHERE n.title =~ '.*Matrix.*' RETURN r
    ]]&gt;&lt;/parameter&gt;
    --&gt;</span>
    <span class="comment">&lt;!-- Optional batch size (requires Neo4j 4.4+) --&gt;</span>
    <span class="comment">&lt;!--
    &lt;parameter name=&quot;batchSize&quot;&gt;23&lt;/parameter&gt;
    --&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="addingsurrogatekeys"><a class="anchor" href="#addingsurrogatekeys"></a>Adding surrogate keys</h4>
<div class="paragraph">
<p>You can use Neo4j-Migrations to add <a href="https://en.wikipedia.org/wiki/Surrogate_key">Surrogate Keys</a> aka technical keys to your Nodes and Relationships. This is especially helpful to migrate away from internal Neo4j ids, such as <code>id()</code> (Neo4j 4.4 and earlier) or <code>elementId()</code>. While these functions are useful and several Object-Graph-Mappers can use them right out of the box, they are often not what you want:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You expose database internals as proxy for your own technical keys</p>
</li>
<li>
<p>Your business now is dependent on the way the database generates them</p>
</li>
<li>
<p>They might get reused (inside Neo4j), leaving you with no good guarantees for an identifier</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Our build-in refactorings use <code>randomUUID()</code> to assign a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> to a property named <code>id</code> for Nodes with a given set of labels or Relationships with a matching type for which such a property does not exist. Both the generator and the name of the property can be individually configured. Also, both type of entities can be matched with a custom query.</p>
</div>
<div class="listingblock">
<div class="title">Listing 42. Adding random UUIDs as ids to <code>Movie</code> Nodes (XML)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addSurrogateKeyTo.nodes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">labels</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;value&gt;</span>Movie<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 43. Adding random UUIDs as ids to <code>Movie</code> Nodes (Java)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> addSurrogateKey = AddSurrogateKey.toNodes(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 44. Adding random UUIDs as ids to <code>ACTED_IN</code> relationships (XML)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addSurrogateKeyTo.relationships</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">type</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>ACTED_IN<span class="tag">&lt;/parameter&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 45. Adding random UUIDs as ids to <code>ACTED_IN</code> relationships (Java)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> addSurrogateKey = AddSurrogateKey.toRelationships(<span class="string"><span class="delimiter">&quot;</span><span class="content">ACTED_IN</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following examples use a different target property and hard-copy the internal id into a property. Of course, you can use your own user-defined functions for generating keys. A single <code>%s</code> will be replaced with a variable holding the matched entity. The syntax for relationships is the same (as demonstrated above):</p>
</div>
<div class="listingblock">
<div class="title">Listing 46. Using a different property and generator function (XML)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">addSurrogateKeyTo.nodes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;parameters&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">labels</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
      <span class="tag">&lt;value&gt;</span>Movie<span class="tag">&lt;/value&gt;</span>
    <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">property</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>movie_pk<span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">generatorFunction</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>id(%s)<span class="tag">&lt;/parameter&gt;</span>
  <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">Listing 47. Using a different property and generator function (Java)</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">var</span> addSurrogateKey = AddSurrogateKey.toNodes(<span class="string"><span class="delimiter">&quot;</span><span class="content">Movie</span><span class="delimiter">&quot;</span></span>)
  .withProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">movie_pk</span><span class="delimiter">&quot;</span></span>)
  .withGeneratorFunction(<span class="string"><span class="delimiter">&quot;</span><span class="content">id(%s)</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="migratingbtreeindexestofutureindexes"><a class="anchor" href="#migratingbtreeindexestofutureindexes"></a>Migrating BTREE indexes to "future" indexes</h4>
<div class="paragraph">
<p>Neo4j 4.4 introduces <a href="https://neo4j.com/docs/cypher-manual/current/indexes-for-search-performance/#indexes-future-indexes">future indexes</a>, <code>RANGE</code> and <code>POINT</code> which replace the well known <code>BTREE</code> indexes of Neo4j 4.x. These new indexes are available from Neo4j 4.4 onwards but will not participate in any query planing in Neo4j 4.4. They exist merely for migration purposes in Neo4j 4.4: Neo4j 5.0 does not support <code>BTREE</code> indexes at all. This means a database that contains <code>BTREE</code> indexes <em>cannot</em> be upgraded to Neo4j 5.0. Existing <code>BTREE</code> indexes need to be dropped prior to attempting the upgrade. The class <code>ac.simons.neo4j.migrations.core.refactorings.MigrateBTreeIndexes</code> has been created for this purpose. It allows creation of matching new indexes and optionally dropping the indexes that are no longer supported in Neo4j 5.0 and higher prior to upgrading the store.</p>
</div>
<div class="paragraph">
<p>As with all the other refactorings, it can be used programmatically in your own application or through Neo4j-Migrations.</p>
</div>
<div class="sect4">
<h5 id="preparinganupgradetoneo4j5.0bycreatingfutureindexesinparallel"><a class="anchor" href="#preparinganupgradetoneo4j5.0bycreatingfutureindexesinparallel"></a>Preparing an upgrade to Neo4j 5.0 by creating future indexes in parallel</h5>
<div class="listingblock">
<div class="title">Listing 48. Creating future indexes in parallel to old indexes</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrate.createFutureIndexes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;parameters&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">suffix</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>_future<span class="tag">&lt;/parameter&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
        <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">excludes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
            <span class="tag">&lt;value&gt;</span>a<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;value&gt;</span>b<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/parameter&gt;</span>
        <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">typeMapping</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span> <i class="conum" data-value="4"></i><b>(4)</b>
            <span class="tag">&lt;mapping&gt;</span>
                <span class="tag">&lt;name&gt;</span>c<span class="tag">&lt;/name&gt;</span>
                <span class="tag">&lt;type&gt;</span>POINT<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;/mapping&gt;</span>
            <span class="tag">&lt;mapping&gt;</span>
                <span class="tag">&lt;name&gt;</span>d<span class="tag">&lt;/name&gt;</span>
                <span class="tag">&lt;type&gt;</span>TEXT<span class="tag">&lt;/type&gt;</span>
            <span class="tag">&lt;/mapping&gt;</span>
        <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>All parameters are optional</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The default suffix is <code>_new</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>An <code>excludes</code> list can be used to exclude items from being processed by name. Its pendant is the <code>includes</code> list. If
the latter is not empty, only the items in the list will be processed</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>By default, <code>RANGE</code> indexes are created. The type mapping allows to map specific old indexes to either <code>RANGE</code>, <code>POINT</code> or <code>TEXT</code>.
The type mappings are not consulted when migrating constraint-backing indexes.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the above refactoring is applied, new indexes and constraints will be created in parallel to the old ones. The refactoring will log statements for dropping the old constraints.</p>
</div>
</div>
<div class="sect4">
<h5 id="preparinganupgradetoneo4j5.0byreplacingbtreeindexeswithfutureindexes"><a class="anchor" href="#preparinganupgradetoneo4j5.0byreplacingbtreeindexeswithfutureindexes"></a>Preparing an upgrade to Neo4j 5.0 by replacing <code>BTREE</code> indexes with future indexes</h5>
<div class="paragraph">
<p>The advantage of this approach is the fact that it won&#8217;t need additional manual work before doing a store upgrade. However, the store upgrade should follow closely after dropping the old indexes and creating the replacement indexes as the latter won&#8217;t participate in planning at all prior to the actual upgrade to Neo4j 5.0 or higher.</p>
</div>
<div class="listingblock">
<div class="title">Listing 49. Replacing <code>BTREE</code> indexes with future indexes</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;refactor</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">migrate.replaceBTreeIndexes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;parameters&gt;</span>
        <span class="tag">&lt;parameter</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">includes</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
            <span class="tag">&lt;value&gt;</span>x<span class="tag">&lt;/value&gt;</span>
            <span class="tag">&lt;value&gt;</span>y<span class="tag">&lt;/value&gt;</span>
        <span class="tag">&lt;/parameter&gt;</span>
    <span class="tag">&lt;/parameters&gt;</span>
<span class="tag">&lt;/refactor&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>suffix</code> parameter is not supported as it is not needed. The other parameters have the same meaning as with <code>migrate.createFutureIndexes</code>. The above example shows the <code>includes</code> parameter.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendix_annotation"><a class="anchor" href="#appendix_annotation"></a>Annotation processing</h3>
<div class="paragraph">
<p>Neo4j-Migrations offers annotation processing for <a href="https://docs.spring.io/spring-data/neo4j/docs/current/reference/html/">SDN 6</a> and generates <a href="#concepts_catalog">catalogs</a> containing unique constraints for all <code>@Node</code> entities using either assigned or externally generated ids (via <code>@Id</code> plus an optional external <code>@GeneratedValue</code> or without further annotation).</p>
</div>
<div class="paragraph">
<p>This is in line with recommended best practices for SDN 6:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use externally assigned or generated IDs instead of Neo4j internal id values (especially when making those ids available to external systems)</p>
</li>
<li>
<p>Create at least indexes for them, better unique constraint to ensure that any assigned value is fit for its purpose</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For more ideas and ruminations around that, please have a look at <a href="https://medium.com/neo4j/neo4j-ogm-and-spring-data-neo4j-a55a866df68c">How to choose an unique identifier for your database entities</a>. While that article is still from an SDN5+OGM perspective, it&#8217;s core ideas still apply.</p>
</div>
<div class="paragraph">
<p>The annotation processor is available under the following coordinates:</p>
</div>
<div class="listingblock">
<div class="title">Listing 50. Annotation processor as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-annotation-processor<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It has no dependencies apart from Neo4j-Migrations itself (neither SDN6 nor Neo4j-OGM), so it is safe to use it either directly as dependency so that it will be picked up by all recent Java compilers or as dedicated processor for the compiler:</p>
</div>
<div class="listingblock">
<div class="title">Listing 51. Annotation processor configured as processor for the compiler plugin inside a Maven pom</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;configuration&gt;</span>
        <span class="tag">&lt;annotationProcessorPaths&gt;</span>
            <span class="tag">&lt;annotationProcessorPath&gt;</span>
                <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
                <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-annotation-processor<span class="tag">&lt;/artifactId&gt;</span>
                <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
            <span class="tag">&lt;/annotationProcessorPath&gt;</span>
        <span class="tag">&lt;/annotationProcessorPaths&gt;</span>
        <span class="tag">&lt;compilerArgs&gt;</span>
            <span class="tag">&lt;arg&gt;</span>-Aorg.neo4j.migrations.catalog_generator.default_catalog_name=R${next-migration-version}__Create_sdn_constraints.xml<span class="tag">&lt;/arg&gt;</span>
            <span class="tag">&lt;arg&gt;</span>-Aorg.neo4j.migrations.catalog_generator.output_dir=my-generated-migrations<span class="tag">&lt;/arg&gt;</span>
        <span class="tag">&lt;/compilerArgs&gt;</span>
    <span class="tag">&lt;/configuration&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The latter approach allows for passing additional configuration to the processor, such as the output location relativ to <code>target/generated-sources</code> and various name generators.
There is a limited API to the processor living in the <code>neo4j-migrations-annotation-processor-api</code> module, such as <code>ac.simons.neo4j.migrations.annotations.proc.ConstraintNameGenerator</code> and the <code>CatalogNameGenerator</code>.
You can provide implementations, but they must live outside the project that is being subject to compilation, as otherwise those classes can&#8217;t be loaded by us.
All implementations must provide a default, publicly accessible constructor or - if they take in any nested options - a public constructor taking in exactly one argument of type <code>Map&lt;String, String&gt;</code>.</p>
</div>
<div class="paragraph">
<p>The scope of the generator is limited on purpose: It will generate a valid catalog declaration and by default an <code>&lt;apply /&gt;</code> operation. The latter is safe todo because catalogs are internally bound to their migration version and elements added or changed in v2 of a catalog will be appended, no elements will be deleted from the known catalog. Optionally the generator can be configured to generate a <code>reset</code> catalog, which will start the catalog at the given version fresh.</p>
</div>
<div class="paragraph">
<p>The generator does not generate a migration in a known migrations directory nor does it use a name that will be picked up Neo4j-Migrations by default. It is your task to configure the build system in such a way that any generated migration will</p>
</div>
<div class="ulist">
<ul>
<li>
<p>have a recognized naming schema</p>
</li>
<li>
<p>a name that evaluates to a correctly ordered version number</p>
</li>
<li>
<p>be part of the directories in the target that are configured to be picked by Neo4j-Migrations</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Taking the above configuration of the processor one exemplary way to take this further is this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 52. Adding generated migrations to the actual target dir</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;plugin&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>maven-resources-plugin<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;executions&gt;</span>
        <span class="tag">&lt;execution&gt;</span>
            <span class="tag">&lt;id&gt;</span>copy-resources<span class="tag">&lt;/id&gt;</span>
            <span class="tag">&lt;goals&gt;</span>
                <span class="tag">&lt;goal&gt;</span>copy-resources<span class="tag">&lt;/goal&gt;</span>
            <span class="tag">&lt;/goals&gt;</span>
            <span class="tag">&lt;phase&gt;</span>process-classes<span class="tag">&lt;/phase&gt;</span>
            <span class="tag">&lt;configuration&gt;</span>
                <span class="tag">&lt;outputDirectory&gt;</span>${project.build.outputDirectory}/neo4j/migrations/<span class="tag">&lt;/outputDirectory&gt;</span>
                <span class="tag">&lt;resources&gt;</span>
                    <span class="tag">&lt;resource&gt;</span>
                        <span class="tag">&lt;directory&gt;</span>${project.build.directory}/generated-sources/annotations/my-generated-migrations<span class="tag">&lt;/directory&gt;</span>
                        <span class="tag">&lt;filtering&gt;</span>false<span class="tag">&lt;/filtering&gt;</span>
                    <span class="tag">&lt;/resource&gt;</span>
                <span class="tag">&lt;/resources&gt;</span>
            <span class="tag">&lt;/configuration&gt;</span>
        <span class="tag">&lt;/execution&gt;</span>
    <span class="tag">&lt;/executions&gt;</span>
<span class="tag">&lt;/plugin&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This works in our examples but bear in mind: The migration will always be regenerated. This is fine as long as you don&#8217;t change your annotated model in any capacity that results in a new or modified index (renaming attributes, labels etc.).</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
The generator will always use idempotent versions of indexes if available in your database. They work well with repeatable migrations.
     So one solution is to configure the generator that it generates a name like <code>R1_2_3__Create_domain_indexes.xml</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>One approach is to add the processor to your build and run a diff with the last "good" generated catalog and the new one. If it is different, add the new catalog under an incremented version number.</p>
</div>
<div class="paragraph">
<p>A simpler approach is using a name generator that is connected to your target dev-database using a <code>Migrations</code> instance and our api (<code>MigrationChain info = migrations.info(MigrationChain.ChainBuilderMode.REMOTE);</code>) to get the latest applied version from the <code>info</code> instance (via <code>.getLastAppliedVersion</code>) and take that and increment it and just add the catalog fresh with a new version if it has change, otherwise resuse the old name.</p>
</div>
<div class="paragraph">
<p>For the naming generation APIs are provided and for the rest, <code>maven-resources-plugin</code> and maybe <code>build-helper-maven-plugin</code> are helpful. The decision to delegate that work has been made as it is rather difficult to propose a one-size-fits-all solution within this tool for all the combinations of different setups and build-systems out there.</p>
</div>
<div class="paragraph">
<p>Options can be passed to name generators via <code>-Aorg.neo4j.migrations.catalog_generator.naming_options=&lt;nestedproperties&gt;</code>  with <code>nestedproperties</code> following a structure like <code>a=x,b=y</code> and so on. If you want to use that, your own name generator must provide a public constructor taking in one single <code>Map&lt;String, String&gt;</code> argument.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Our recommended approach is to use <code>javac</code> directly and script it&#8217;s invocation in your CI/CD system
     as shown in the following paragraph!
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="additionalannotations"><a class="anchor" href="#additionalannotations"></a>Additional annotations</h4>
<div class="paragraph">
<p>We offer a set of additional annotations - <code>@Unique</code>, <code>@Required</code> and <code>@Fulltext</code> that can be used standalone or together with SDN6 <em>or</em> OGM to specify constraints on classes. Please check the JavaDoc of those annotations about their usage. The module as shown below has no dependencies, neither on Neo4j-Migrations, nor SDN6 or OGM. While it works excellent with SDN6 for specifying additional information, all annotations offer a way to define labels and relationship types.</p>
</div>
<div class="listingblock">
<div class="title">Listing 53. Annotation processor as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-annotation-catalog<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Combined with SDN6, a valid definition would look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.util.UUID</span>;

<span class="keyword">import</span> <span class="include">org.springframework.data.neo4j.core.schema.GeneratedValue</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.neo4j.core.schema.Id</span>;
<span class="keyword">import</span> <span class="include">org.springframework.data.neo4j.core.schema.Node</span>;

<span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.annotations.catalog.Required</span>;
<span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.annotations.catalog.Unique</span>;

<span class="annotation">@Node</span>
<span class="directive">public</span> record Organization(
        <span class="annotation">@Id</span> <span class="annotation">@GeneratedValue</span> <span class="annotation">@Unique</span> <span class="predefined-type">UUID</span> id, <i class="conum" data-value="1"></i><b>(1)</b>
        <span class="annotation">@Required</span> <span class="predefined-type">String</span> name) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Technically, the <code>@Unique</code> annotation isn&#8217;t necessary here and the processor will generate a constraint for that field out of the box, but we think it reads better that way.</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="usingjavacandourannotationprocessor"><a class="anchor" href="#usingjavacandourannotationprocessor"></a>Using Javac and our annotation processor</h4>
<div class="paragraph">
<p>The annotation processor itself is made of 3 artifacts:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>neo4j-migrations-2.20.0.jar</code></dt>
<dd>
<p>Needed to generate the catalogs</p>
</dd>
<dt class="hdlist1"><code>neo4j-migrations-annotation-processor-api-2.20.0.jar</code></dt>
<dd>
<p>Contains the API and built-in annotations</p>
</dd>
<dt class="hdlist1"><code>neo4j-migrations-annotation-processor-2.20.0.jar</code> </dt>
<dd>
<p>The processor itself</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>You need to make sure to include all of them in the processor path, otherwise you will most likely read something like <code>error: Bad service configuration file, or exception thrown while constructing Processor object: javax.annotation.processing.Processor: ac.simons.neo4j.migrations.annotations.proc.impl.CatalogGeneratingProcessor Unable to get public no-arg constructor</code>, which is a bit misleading.</p>
</div>
<div class="sect4">
<h5 id="forogmentities"><a class="anchor" href="#forogmentities"></a>For OGM entities</h5>
<div class="paragraph">
<p>You need at least <code>neo4j-ogm-core</code> as dependency for processing Neo4j-OGM entities and most likely all libraries that you are used in addition to OGM annotations in those entities. The following statement generates <code>V01__Create_OGM_schema.xml</code> in a directory <code>output</code>. It only does annotation processing:</p>
</div>
<div class="listingblock">
<div class="title">Listing 54. Generating a catalog from Neo4j-OGM entities</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">javac -proc:only \
-processorpath neo4j-migrations-2.20.0.jar:neo4j-migrations-annotation-processor-api-2.20.0.jar:neo4j-migrations-annotation-processor-2.20.0.jar \
-Aorg.neo4j.migrations.catalog_generator.output_dir=output \
-Aorg.neo4j.migrations.catalog_generator.default_catalog_name=V01__Create_OGM_schema.xml \
-cp neo4j-ogm-core-4.0.0.jar \
extensions/neo4j-migrations-annotation-processing/processor/src/test/java/ac/simons/neo4j/migrations/annotations/proc/ogm/*</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="forsdnentities"><a class="anchor" href="#forsdnentities"></a>For SDN Entities</h5>
<div class="paragraph">
<p>The only difference here is that you must use SDN 6.0+ and its dependencies as a dependencies to JavaC:</p>
</div>
<div class="listingblock">
<div class="title">Listing 55. Generating a catalog from Neo4j-OGM entities</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">javac -proc:only \
-processorpath neo4j-migrations-2.20.0.jar:neo4j-migrations-annotation-processor-api-2.20.0.jar:neo4j-migrations-annotation-processor-2.20.0.jar \
-Aorg.neo4j.migrations.catalog_generator.output_dir=output \
-Aorg.neo4j.migrations.catalog_generator.default_catalog_name=V01__Create_SDN6_schema.xml \
-cp apiguardian-api-1.1.2.jar:spring-data-commons-2.7.2.jar:spring-data-neo4j-6.3.2.jar \
extensions/neo4j-migrations-annotation-processing/processor/src/test/java/ac/simons/neo4j/migrations/annotations/proc/sdn6/movies/*</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="forclassesannotatedwithcatalogannotations"><a class="anchor" href="#forclassesannotatedwithcatalogannotations"></a>For classes annotated with catalog annotations</h5>
<div class="paragraph">
<p>No additional jars apart from the dedicated annotations are necessary</p>
</div>
<div class="listingblock">
<div class="title">Listing 56. Generating a catalog from plain annotated classes</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">javac -proc:only \
-processorpath neo4j-migrations-2.20.0.jar:neo4j-migrations-annotation-processor-api-2.20.0.jar:neo4j-migrations-annotation-processor-2.20.0.jar \
-Aorg.neo4j.migrations.catalog_generator.output_dir=output \
-Aorg.neo4j.migrations.catalog_generator.default_catalog_name=R01__Create_annotated_schema.xml \
-cp neo4j-migrations-annotation-catalog-2.20.0 \
extensions/neo4j-migrations-annotation-processing/processor/src/test/java/ac/simons/neo4j/migrations/annotations/proc/catalog/valid/CoffeeBeanPure*</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="neo4j5.9propertytypeconstraints"><a class="anchor" href="#neo4j5.9propertytypeconstraints"></a>Neo4j 5.9+ property type constraints</h5>
<div class="paragraph">
<p>The annotation processor can create property type constraints from OGM and SDN models.
These constraints will ensure that the database schema enforces the datatypes declared in the models.
To enable that feature, configure the processor with <code>-Aorg.neo4j.migrations.catalog_generator.generate_type_constraints=true`</code></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="appendix_extesions"><a class="anchor" href="#appendix_extesions"></a>Extensions</h3>
<div class="sect3">
<h4 id="csvsupportexperimental"><a class="anchor" href="#csvsupportexperimental"></a>CSV Support (Experimental)</h4>
<div class="sect4">
<h5 id="whatdoesitdo"><a class="anchor" href="#whatdoesitdo"></a>What does it do?</h5>
<div class="paragraph">
<p>This module consists of some abstract bases classes that helps you to use data in CSV files during migration. The idea is that you have some CSV data you want to use <code>LOAD CSV</code>. Depending on whether the data has been changed or not, you need want to repeat the migration or not.</p>
</div>
<div class="paragraph">
<p>We have basically everything in place:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java based migrations that can be repeated or not</p>
</li>
<li>
<p>Check-summing based on whatever.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>What we can do for you is check-summing CSV data on HTTP urls for you. What you need to do is make them available to both Neo4j and this tool and provide a query to deal with them. Our tooling brings it together. Essentially, you want to inherit from <code>ac.simons.neo4j.migrations.formats.csv.AbstractLoadCSVMigration</code> like this:</p>
</div>
<div class="listingblock">
<div class="title">Listing 57. R050__LoadBookData.java</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">import</span> <span class="include">java.net.URI</span>;

<span class="keyword">import</span> <span class="include">org.neo4j.driver.Query</span>;

<span class="keyword">import</span> <span class="include">ac.simons.neo4j.migrations.formats.csv.AbstractLoadCSVMigration</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">R050__LoadBookData</span> <span class="directive">extends</span> AbstractLoadCSVMigration {

    <span class="directive">public</span> R050__LoadBookData() {
        <span class="local-variable">super</span>(<span class="predefined-type">URI</span>.create(<span class="string"><span class="delimiter">&quot;</span><span class="content">https://codeberg.org/michael-simons/goodreads/raw/branch/main/all.csv</span><span class="delimiter">&quot;</span></span>), <span class="predefined-constant">true</span>);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">Query</span> getQuery() {
        <span class="comment">// language=cypher</span>
        <span class="keyword">return</span> <span class="keyword">new</span> <span class="predefined-type">Query</span>(<span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="content">
            LOAD CSV WITH HEADERS FROM '%s' AS row FIELDTERMINATOR ','
            MERGE (b:Book {title: trim(row.Title)})
            SET b.type = row.Type, b.state = row.State
            WITH b, row
            UNWIND split(row.Author, '&amp;') AS author
            WITH b, split(author, ',') AS author
            WITH b, ((trim(coalesce(author[1], '')) + ' ') + trim(author[0])) AS author
            MERGE (a:Person {name: trim(author)})
            MERGE (a)-[r:WROTE]-&gt;(b)
            WITH b, a
            WITH b, collect(a) AS authors
            RETURN b.title, b.state, authors
            </span><span class="delimiter">&quot;</span></span><span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span>);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, we decide that the CSV data might change and therefor we indicate this migration being repeatable in the constructor call. If this is the case, we suggest using a class name reflecting that. If you use <code>false</code> during construction, migrations will fail if the data changes. The Cypher being used here does a merge and therefor, we added constraints to the title and person names beforehand. You may choose to omit the <code>%s</code> in the query template, but we suggest to use for the URI.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="asciidoctorsupportexperimental"><a class="anchor" href="#asciidoctorsupportexperimental"></a>AsciiDoctor Support (Experimental)</h4>
<div class="sect4">
<h5 id="whatdoesitdo2"><a class="anchor" href="#whatdoesitdo2"></a>What does it do?</h5>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Please open this <code>README.adoc</code> not only in a rendered view, but have a look at the raw asciidoc version!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When added to one of the supported use-case scenarios as an external library, it allows  Neo4j-Migrations to discover
AsciiDoctor files and use them as sources of Cypher statements for defining refactorings.</p>
</div>
<div class="paragraph">
<p>An AsciiDoctor based migration can have zero to many code blocks of type <code>cypher</code> with an id matching our versioning scheme
and valid inline Cypher content. The block definition looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="asciidoc">[source,cypher,id=V1.0__Create_initial_data]
----
// Your Cypher based migration
----</code></pre>
</div>
</div>
<div class="paragraph">
<p>In fact, this <code>README.adoc</code> is a source of migrations on its own. It contains the following refactorings:</p>
</div>
<div id="V1.0__Create_initial_data" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE (a:Author {
  id: randomUUID(),
  name: 'Stephen King'
})
CREATE (b:Book {
  id: randomUUID(),
  name: 'The Dark Tower'
})
CREATE (a)-[:WROTE]-&gt;(b)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can have as many migrations as we want.</p>
</div>
<div id="V1.1__Add_more_data" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">MATCH (a:Author {
  name: 'Stephen King'
})
CREATE (b:Book  {
  id: randomUUID(),
  name: 'Atlantis'
})
CREATE (a)-[:WROTE]-&gt;(b);


CREATE (a:Author {
  id: randomUUID(),
  name: 'Grace Blakeley'
})
CREATE (b:Book {
  id: randomUUID(),
  name: 'Stolen: How to Save the World From Financialisation'
})
CREATE (a)-[:WROTE]-&gt;(b);</code></pre>
</div>
</div>
<div class="paragraph">
<p>And to make queries on peoples name perform fast, we should add some indexes and constraints.
This we do with a separate document, <code>V1.2__Create_id_constraints.xml</code> to be included here:</p>
</div>
<div id="V1.2__Create_id_constraints" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;migration</span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">https://michael-simons.github.io/neo4j-migrations</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;catalog&gt;</span>
    <span class="tag">&lt;indexes&gt;</span>
      <span class="tag">&lt;index</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idx_author_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Author<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>name<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/index&gt;</span>
      <span class="tag">&lt;index</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">idx_book_name</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Book<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>name<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/index&gt;</span>
    <span class="tag">&lt;/indexes&gt;</span>
    <span class="tag">&lt;constraints&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_id_author</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Author<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>id<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
      <span class="tag">&lt;constraint</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique_id_book</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">unique</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;label&gt;</span>Book<span class="tag">&lt;/label&gt;</span>
        <span class="tag">&lt;properties&gt;</span>
          <span class="tag">&lt;property&gt;</span>id<span class="tag">&lt;/property&gt;</span>
        <span class="tag">&lt;/properties&gt;</span>
      <span class="tag">&lt;/constraint&gt;</span>
    <span class="tag">&lt;/constraints&gt;</span>
  <span class="tag">&lt;/catalog&gt;</span>

  <span class="tag">&lt;apply</span><span class="tag">/&gt;</span>
<span class="tag">&lt;/migration&gt;</span></code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Includes are <strong>not</strong> processed. To make the system process the above xml content respectively any included Cypher
         file, these files must live in a configured location, as described in the manual.
        <br>
         We opted against resolving includes for two reasons: It&#8217;s easier to reason about the sources of migrations when just
         inline code is processed and also, inclusion of arbitrary URLs may expose a security risk.
        <br>
         Please have a look at the source of <strong>this</strong> file itself to understand what works and what not.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following block is an example of an included Cypher file, that will be used from its own location when this changeset is applied,
but can still be referenced in this documentation:</p>
</div>
<div id="V2.0__Add_likes" class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="cypher">CREATE (m:User {
  name: 'Michael'
})
WITH m
MATCH (a:Author {
  name: 'Stephen King'
})-[:WROTE]-&gt;(b)
WITH m, a, collect(b) AS books
CREATE (m)-[:LIKES]-&gt;(a)
WITH m, books
UNWIND books AS b
CREATE (m)-[:LIKES]-&gt;(b);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The checksum of AsciiDoctor based migrations is computed individually per Cypher block, not for the whole file. So one
AsciiDoctor file basically behaves as a container for many migrations.</p>
</div>
</div>
<div class="sect4">
<h5 id="howtouseit"><a class="anchor" href="#howtouseit"></a>How to use it?</h5>
<div class="paragraph">
<p>The extension is loaded via service loader. In a standard Spring Boot or Quarkus application you just need to add one additional
dependency:</p>
</div>
<div class="listingblock">
<div class="title">Listing 58. AsciiDoctor extension as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-formats-adoc<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in case you fancy Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Listing 59. AsciiDoctor extension as Gradle dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation <span class="string"><span class="delimiter">'</span><span class="content">eu.michael-simons.neo4j:neo4j-migrations-formats-adoc:2.20.0</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s all.</p>
</div>
<div class="paragraph">
<p>For the CLI, you should download the <code>-all</code> artifact from Maven Central: <a href="https://repo.maven.apache.org/maven2/eu/michael-simons/neo4j/neo4j-migrations-formats-adoc/2.20.0/neo4j-migrations-formats-adoc-2.20.0-all.jar">neo4j-migrations-formats-adoc-2.20.0-all.jar</a>
This will work only with the JVM based CLI version, which is available <a href="https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip">here</a>.</p>
</div>
<div class="paragraph">
<p>A full example looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip
curl -LO https://repo.maven.apache.org/maven2/eu/michael-simons/neo4j/neo4j-migrations-formats-adoc/2.20.0/neo4j-migrations-formats-adoc-2.20.0-all.jar
unzip neo4j-migrations-2.20.0.zip
cd neo4j-migrations-2.20.0
CLASSPATH_PREFIX=../neo4j-migrations-formats-adoc-2.20.0-all.jar \
  bin/neo4j-migrations --password secret \
  --location file:///path/to/neo4j/adoc-migrations \
  info</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will result in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j@localhost:7687 (Neo4j/4.4.4)
Database: neo4j

+---------+---------------------------+---------+---------+----------------------------------------------+
| Version | Description               | Type    | State   | Source                                       |
+---------+---------------------------+---------+---------+----------------------------------------------+
| 1.0     | initial data              | CYPHER  | PENDING | initial_schema_draft.adoc#V1.0__initial_data |
| 1.2     | more data                 | CYPHER  | PENDING | initial_schema_draft.adoc#V1.2__more_data    |
| 2.0     | lets rock                 | CYPHER  | PENDING | more_content.adoc#V2.0__lets_rock            |
| 3.0     | We forgot the constraints | CATALOG | PENDING | V3.0__We_forgot_the_constraints.xml          |
| 4.0     | Plain cypher              | CYPHER  | PENDING | V4.0__Plain_cypher.cypher                    |
+---------+---------------------------+---------+---------+----------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note: empty columns have been omitted for brevity.)</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="markdownsupportexperimental"><a class="anchor" href="#markdownsupportexperimental"></a>Markdown Support (Experimental)</h4>
<div class="sect4">
<h5 id="whatdoesitdo3"><a class="anchor" href="#whatdoesitdo3"></a>What does it do?</h5>
<div class="paragraph">
<p>When added to one of the supported use-case scenarios as an external library, it allows Neo4j-Migrations to discover
Markdown files and use them as sources of Cypher statements for defining refactorings.</p>
</div>
<div class="paragraph">
<p>A Markdown based migration can have zero to many fenced code blocks with an id matching our versioning scheme
and valid inline Cypher content. The block definition looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="markdown">```id=V1.0__Create_initial_data
// Your Cypher based migration</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="howtouseit2"><a class="anchor" href="#howtouseit2"></a>How to use it?</h5>
<div class="paragraph">
<p>The extension is loaded via service loader. In a standard Spring Boot or Quarkus application you just need to add one additional
dependency:</p>
</div>
<div class="listingblock">
<div class="title">Listing 60. Markdown extension as Maven dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;dependency&gt;</span>
    <span class="tag">&lt;groupId&gt;</span>eu.michael-simons.neo4j<span class="tag">&lt;/groupId&gt;</span>
    <span class="tag">&lt;artifactId&gt;</span>neo4j-migrations-formats-markdown<span class="tag">&lt;/artifactId&gt;</span>
    <span class="tag">&lt;version&gt;</span>2.20.0<span class="tag">&lt;/version&gt;</span>
<span class="tag">&lt;/dependency&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Or in case you fancy Gradle:</p>
</div>
<div class="listingblock">
<div class="title">Listing 61. AsciiDoctor extension as Gradle dependency</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="groovy">dependencies {
    implementation <span class="string"><span class="delimiter">'</span><span class="content">eu.michael-simons.neo4j:neo4j-migrations-formats-markdown:2.20.0</span><span class="delimiter">'</span></span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>And that&#8217;s all.</p>
</div>
<div class="paragraph">
<p>For the CLI, you should download the <code>-all</code> artifact from Maven Central: <a href="https://repo.maven.apache.org/maven2/eu/michael-simons/neo4j/neo4j-migrations-formats-markdown/2.20.0/neo4j-migrations-formats-markdown-2.20.0-all.jar">neo4j-migrations-formats-markdown-2.20.0-all.jar</a>
This will work only with the JVM based CLI version, which is available <a href="https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip">here</a>.</p>
</div>
<div class="paragraph">
<p>A full example looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">curl -LO https://github.com/michael-simons/neo4j-migrations/releases/download/2.20.0/neo4j-migrations-2.20.0.zip
curl -LO https://repo.maven.apache.org/maven2/eu/michael-simons/neo4j/neo4j-migrations-formats-markdown/2.20.0/neo4j-migrations-formats-markdown-2.20.0-all.jar
unzip neo4j-migrations-2.20.0.zip
cd neo4j-migrations-2.20.0
CLASSPATH_PREFIX=../neo4j-migrations-formats-markdown-2.20.0-all.jar \
  bin/neo4j-migrations --password secret \
  --location file:///path/to/neo4j/markdown-migrations \
  info</code></pre>
</div>
</div>
<div class="paragraph">
<p>Which will result in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="console">neo4j@localhost:7687 (Neo4j/4.4.8)
Database: neo4j

+---------+---------------------+--------+---------+--------------------------------------------+
| Version | Description         | Type   | State   | Source                                     |
+---------+---------------------+--------+---------+--------------------------------------------+
| 1.0     | initial data        | CYPHER | PENDING | initial_schema_draft.md#V1.0__initial_data |
| 1.2     | more data           | CYPHER | PENDING | initial_schema_draft.md#V1.2__more_data    |
| 1.3     | something different | CYPHER | PENDING | more_content.md#V1.3__something_different  |
+---------+---------------------+--------+---------+--------------------------------------------+</code></pre>
</div>
</div>
<div class="paragraph">
<p>(Note: empty columns have been omitted for brevity.)</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-10-28 14:24:37 UTC
</div>
</div>
</body>
</html>